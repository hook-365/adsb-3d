<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>adsb-3d</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cookie&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           THEME VARIABLES - Unified Design System
           ======================================== */
        :root {
            /* Accent Colors */
            --accent-primary: #4a9eff;
            --accent-primary-dim: rgba(74, 158, 255, 0.3);
            --accent-primary-hover: rgba(74, 158, 255, 0.5);
            --accent-primary-active: rgba(74, 158, 255, 0.6);

            /* Panel Backgrounds */
            --panel-bg: rgba(0, 0, 0, 0.7);
            --panel-bg-solid: rgba(0, 0, 0, 0.85);
            --panel-border: rgba(74, 158, 255, 0.3);

            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --text-accent: #4a9eff;

            /* Panel Styling */
            --panel-padding: 15px;
            --panel-radius: 8px;
            --panel-blur: blur(10px);
            --panel-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            --panel-border-width: 1px;
            --panel-border-style: solid;

            /* Button Styling */
            --button-radius: 6px;
            --button-shadow: none;

            /* Input Styling */
            --input-radius: 4px;

            /* Badge Styling */
            --badge-radius: 4px;

            /* Typography */
            --font-weight-headers: 600;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-size-base: 12px;
            --font-size-large: 14px;
            --font-size-heading: 16px;
            --font-size-title: 18px;

            /* Spacing */
            --spacing-xs: 5px;
            --spacing-sm: 8px;
            --spacing-md: 10px;
            --spacing-lg: 15px;
            --spacing-xl: 20px;

            /* Z-Index Layers */
            --z-controls: 50;
            --z-panels: 100;
            --z-modals: 1000;

            /* ===== STATUS & STATE COLORS ===== */
            --status-success: #4eff9e;
            --status-success-bg: rgba(78, 255, 158, 0.1);
            --status-success-glow: rgba(78, 255, 158, 0.6);

            --status-error: #ff4a4a;
            --status-error-bg: rgba(255, 74, 74, 0.1);

            --status-warning: #ffaa4a;
            --status-warning-bg: rgba(255, 170, 74, 0.1);

            --status-offline: #888888;

            --mode-active: #00c853;
            --mode-active-border: #00e676;
            --mode-active-glow: rgba(0, 230, 118, 0.5);

            /* ===== BADGES & LABELS ===== */
            --badge-military: #cc0000;
            --badge-military-text: #ffffff;
            --badge-mlat: #d97634;
            --badge-mlat-text: #ffffff;
            --badge-stat: #1e5a8e;
            --badge-stat-text: #ffffff;

            /* ===== 3D SCENE ELEMENTS ===== */
            --military-color: #ff0000;
            --compass-north: #ff4444;
            --airport-label-bg: rgba(100, 100, 100, 0.7);
            --airport-label-text: #ffffff;
            --distance-ring-1: #888888;
            --distance-ring-2: #aaaaaa;
            --grid-center: #444444;
            --grid-lines: #2a2a2a;

            /* ===== SKY & LIGHTING ===== */
            --scene-fog: #87CEEB;
            --scene-ambient: #87CEEB;
            --scene-sun: #ffffee;
            --scene-ground: #5c7a3c;

            /* ===== RUNWAY & AIRPORT ===== */
            --runway-color: #ffffff;
            --tower-base: #eeeeee;
            --tower-light: #ff0000;
            --home-marker: #ffffff;

            /* ===== TRAIL & CURTAIN ===== */
            --trail-ground: #333333;
            --trail-selected: #ffffff;

            /* ===== MODAL & UI ===== */
            --modal-text-muted: #666666;
            --modal-text-strong: #cccccc;
            --modal-text-note: #888888;
            --bg-canvas: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-canvas);
            overflow: hidden;
            color: var(--text-primary);
        }

        /* ========================================
           UTILITY CLASSES - Consistent Styling System
           ======================================== */

        /* Panel Base - Apply to all panels for consistency */
        .panel-base {
            position: absolute;
            background: var(--panel-bg);
            padding: var(--panel-padding);
            border-radius: var(--panel-radius);
            backdrop-filter: var(--panel-blur);
            border: var(--panel-border-width) var(--panel-border-style) var(--panel-border);
            box-shadow: var(--panel-shadow);
            touch-action: auto;
            z-index: var(--z-panels);
        }

        .panel-solid {
            background: var(--panel-bg-solid);
        }

        /* Desktop Positioning */
        .pos-top-right {
            top: var(--spacing-xl);
            right: var(--spacing-xl);
        }

        .pos-top-left {
            top: var(--spacing-xl);
            left: var(--spacing-xl);
        }

        .pos-bottom-left {
            bottom: 100px;  /* Above footer */
            left: var(--spacing-xl);
        }

        /* Mobile Responsive Utilities */
        @media (max-width: 768px) {
            /* Mobile panel alignment - below mode selector */
            .mobile-panel-aligned {
                top: 50px !important;
                left: 10px !important;
                right: 10px !important;
                max-width: none !important;
                min-width: 0 !important;
                margin: 0 !important;
            }

            /* Mobile compact spacing */
            .mobile-compact-padding {
                padding: 8px !important;
            }

            .mobile-compact-gap {
                gap: 6px !important;
            }

            /* Mobile text sizing */
            .mobile-text-sm {
                font-size: 10px !important;
            }

            .mobile-text-md {
                font-size: 11px !important;
            }

            .mobile-text-lg {
                font-size: 12px !important;
            }
        }

        /* Spacing Utilities */
        .m-0 { margin: 0; }
        .m-sm { margin: var(--spacing-sm); }
        .m-md { margin: var(--spacing-md); }
        .p-0 { padding: 0; }
        .p-sm { padding: var(--spacing-sm); }
        .p-md { padding: var(--spacing-md); }
        .gap-xs { gap: var(--spacing-xs); }
        .gap-sm { gap: var(--spacing-sm); }
        .gap-md { gap: var(--spacing-md); }

        /* Text Utilities */
        .text-accent { color: var(--text-accent); }
        .text-secondary { color: var(--text-secondary); }
        .text-primary { color: var(--text-primary); }
        .text-xs { font-size: 11px; }
        .text-sm { font-size: var(--font-size-base); }
        .text-md { font-size: var(--font-size-large); }
        .text-lg { font-size: var(--font-size-heading); }
        .text-xl { font-size: var(--font-size-title); }

        /* Layout Utilities */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }

        /* Z-Index Utilities */
        .z-controls { z-index: var(--z-controls); }
        .z-panels { z-index: var(--z-panels); }
        .z-mode-selector { z-index: 110; }
        .z-modals { z-index: var(--z-modals); }

        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            touch-action: none; /* Prevent default touch behaviors on canvas */
        }

        /* ========================================
           PANEL BASE STYLES
           ======================================== */
        #info {
            position: absolute;
            top: var(--spacing-xl);
            left: var(--spacing-xl);
            background: var(--panel-bg);
            padding: var(--panel-padding) var(--spacing-xl);
            border-radius: var(--panel-radius);
            backdrop-filter: var(--panel-blur);
            border: 1px solid var(--panel-border);
            max-width: 300px;
            font-size: var(--font-size-large);
            line-height: 1.6;
            touch-action: auto;
            z-index: var(--z-panels);
        }

        #info h1 {
            font-size: var(--font-size-title);
            margin-bottom: var(--spacing-md);
            color: var(--text-accent);
        }

        .stat {
            display: flex;
            justify-content: space-between;
            margin: var(--spacing-xs) 0;
        }

        .stat .label {
            color: var(--text-secondary);
        }

        .stat .value {
            color: var(--text-primary);
            font-weight: bold;
        }

        /* Bottom Footer Bar */
        #footer-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--panel-bg-solid);
            backdrop-filter: var(--panel-blur);
            border-top: 1px solid var(--panel-border);
            padding: 8px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            z-index: 1000;
            font-size: 13px;
        }

        #footer-altitude {
            width: 100%;
            max-width: 500px;
            padding: 0 8px;
            box-sizing: border-box;
        }

        #footer-altitude .altitude-content {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        #footer-altitude .altitude-label {
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        #footer-altitude .gradient-bar {
            height: 16px;
            flex: 1;
            min-width: 0;
            border-radius: 8px;
            background: linear-gradient(to right,
                hsl(0, 0%, 45%) 0%,
                hsl(20, 88%, 44%) 5%,
                hsl(40, 88%, 44%) 10%,
                hsl(60, 88%, 44%) 15%,
                hsl(80, 88%, 44%) 20%,
                hsl(100, 88%, 44%) 25%,
                hsl(120, 88%, 44%) 30%,
                hsl(140, 88%, 44%) 35%,
                hsl(160, 88%, 44%) 45%,
                hsl(180, 88%, 44%) 55%,
                hsl(200, 88%, 44%) 65%,
                hsl(220, 88%, 44%) 75%,
                hsl(240, 88%, 44%) 80%,
                hsl(260, 88%, 44%) 85%,
                hsl(280, 88%, 44%) 90%,
                hsl(300, 88%, 44%) 95%,
                hsl(300, 88%, 44%) 100%
            );
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        #footer-altitude .labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--text-secondary);
            padding: 0 24px;
        }

        #footer-links {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 10px;
        }

        .footer-link {
            color: var(--text-accent);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid var(--accent-primary-dim);
            padding: 2px 8px;
            border-radius: 6px;
        }

        .footer-link:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .footer-link.coffee-link {
            font-family: 'Cookie', cursive;
            font-size: 18px;
        }

        .footer-separator {
            color: var(--text-secondary);
        }

        /* About Modal */
        #about-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            touch-action: auto;
        }

        #about-modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #about-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(74, 158, 255, 0.5);
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -20px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* Keyboard Help Modal */
        /* Keyboard Help Sidebar (NEW) */
        #keyboard-help-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 350px;
            height: 100vh;
            background: var(--panel-bg-solid);
            border-right: 1px solid var(--panel-border);
            z-index: 9998;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #keyboard-help-sidebar.show {
            transform: translateX(0);
        }

        #keyboard-help-sidebar .header {
            padding: 15px;
            border-bottom: 1px solid var(--panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #keyboard-help-sidebar h2 {
            margin: 0;
            font-size: 18px;
            color: var(--text-accent);
        }

        #keyboard-help-sidebar .close-btn-help {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #keyboard-help-sidebar .close-btn-help:hover {
            color: var(--text-accent);
        }

        #keyboard-help-sidebar .content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        #keyboard-help-sidebar .shortcut-group {
            margin-bottom: 20px;
        }

        #keyboard-help-sidebar .shortcut-group-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-accent);
            text-transform: uppercase;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--panel-border);
        }

        #keyboard-help-sidebar .shortcut-item {
            display: grid;
            grid-template-columns: 50px 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }

        #keyboard-help-sidebar kbd {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 11px;
            white-space: nowrap;
            text-align: center;
            color: var(--text-accent);
        }

        #keyboard-help-sidebar .shortcut-desc {
            color: var(--text-secondary);
        }

        #keyboard-help-sidebar .mode-indicator {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Keyboard help overlay */
        #keyboard-help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9997;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #keyboard-help-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Legacy modal (kept for compat) */
        #keyboard-help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            touch-action: auto;
        }

        #keyboard-help-modal.show {
            display: flex;
        }

        #keyboard-help-modal .modal-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(74, 158, 255, 0.5);
            border-radius: 12px;
            padding: 30px 40px;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }

        #keyboard-help-modal h2 {
            color: var(--text-accent);
            margin: 0 0 20px 0;
            font-size: 24px;
        }

        #keyboard-help-modal kbd {
            background: var(--accent-primary-dim);
            border: 1px solid var(--accent-primary-hover);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 14px;
            color: var(--text-accent);
            font-weight: bold;
        }

        /* Theme Modal Styles */
        #theme-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            touch-action: auto;
        }

        #theme-modal.show {
            display: flex;
        }

        #theme-modal h2 {
            color: var(--text-accent);
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .theme-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--panel-border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .theme-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary-hover);
            transform: translateY(-2px);
        }

        .theme-card.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary-dim);
        }

        .theme-preview {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
            height: 40px;
        }

        .preview-color {
            flex: 1;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-card h3 {
            color: var(--text-primary);
            font-size: 14px;
            margin: 0 0 4px 0;
            font-weight: bold;
        }

        .theme-card p {
            color: var(--text-secondary);
            font-size: 11px;
            margin: 0;
        }

        .theme-active-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--status-success);
            color: #000;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
        }

        .theme-card.active .theme-active-indicator {
            display: block;
        }

        #about-content h2 {
            color: var(--text-accent);
            margin: 0 0 20px 0;
            font-size: 28px;
            border-bottom: 2px solid var(--panel-border);
            padding-bottom: 10px;
        }

        #about-content h3 {
            color: var(--text-accent);
            font-size: 16px;
            margin: 20px 0 10px 0;
        }

        #about-content p {
            color: var(--modal-text-strong);
            line-height: 1.8;
            margin: 15px 0;
            font-size: 14px;
        }

        #about-content .version {
            color: var(--text-accent);
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
        }

        #about-content .author {
            color: var(--text-secondary);
            font-size: 13px;
            margin: 10px 0;
        }

        #about-content a {
            color: var(--text-accent);
            text-decoration: none;
        }

        #about-content a:hover {
            color: var(--accent-primary);
        }

        #about-content strong {
            color: var(--modal-text-strong);
        }

        #about-content .note {
            font-size: 10px;
            color: var(--modal-text-muted);
            font-style: italic;
        }

        #about-content .data-source {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 10px;
        }

        /* Utility classes for labels and text */
        .section-label {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-accent);
            font-size: 13px;
        }

        .label-bold {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-accent);
        }

        .text-muted-sm {
            font-size: 11px;
            color: var(--modal-text-note);
        }

        .help-text {
            font-size: 11px;
            color: var(--modal-text-note);
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .playback-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .playback-btn {
            flex: 0 0 auto;
            padding: 8px 16px;
            font-size: 12px;
        }

        .playback-btn-small {
            flex: 0 0 auto;
            padding: 8px 12px;
            font-size: 12px;
        }

        .playback-speed-select {
            flex: 1 1 auto;
            min-width: 100px;
            max-width: 150px;
        }

        .timeline-times {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--modal-text-note);
            margin-bottom: 8px;
        }

        .playback-status {
            font-size: 11px;
            color: var(--modal-text-note);
            text-align: center;
        }

        .action-btn {
            grid-column: 1 / -1;
            background: var(--accent-primary-dim);
            color: var(--text-primary);
            border: 1px solid var(--accent-primary-hover);
            padding: var(--spacing-sm);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--accent-primary);
        }

        .secondary-btn {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: var(--spacing-sm);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .full-width-btn {
            margin-top: 15px;
            padding: 8px 16px;
            background: var(--accent-primary);
            border: 1px solid var(--accent-primary-hover);
            color: var(--button-text);
            cursor: pointer;
            border-radius: 4px;
            width: 100%;
        }

        .full-width-btn:hover {
            background: var(--accent-primary-hover);
        }

        .timeline-scrubber {
            width: 100%;
            cursor: pointer;
        }

        #about-content .github-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--accent-primary-dim);
            border: 1px solid var(--accent-primary-hover);
            border-radius: 6px;
            color: var(--text-accent);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        #about-content .github-link:hover {
            background: var(--accent-primary-hover);
            border-color: var(--accent-primary-active);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--accent-primary-hover);
        }

        #about-content .github-link.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        #about-content .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        #about-content .close-btn:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        #about-content .feature-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        #about-content .feature-list li {
            padding: 5px 0 5px 20px;
            position: relative;
            color: var(--modal-text-strong);
            font-size: 13px;
        }

        #about-content .feature-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--text-accent);
            font-weight: bold;
        }

        #aircraft-list {
            position: absolute;
            top: 90px;  /* Below mode selector */
            right: var(--spacing-xl);
            background: var(--panel-bg);
            padding: var(--panel-padding);
            border-radius: var(--panel-radius);
            backdrop-filter: var(--panel-blur);
            border: 1px solid var(--panel-border);
            width: 310px;  /* Fixed width to prevent expansion on hover */
            max-height: calc(80vh - 70px);
            overflow-y: auto;
            font-size: var(--font-size-base);
            touch-action: auto;
            -webkit-overflow-scrolling: touch;
            z-index: var(--z-panels);
        }

        #aircraft-list h2 {
            font-size: var(--font-size-heading);
            margin-bottom: var(--spacing-md);
            color: var(--text-accent);
        }

        .aircraft-item {
            padding: var(--spacing-sm);
            margin: var(--spacing-xs) 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .aircraft-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent-primary);
        }

        .aircraft-item.selected {
            background: var(--accent-primary-dim);
            border-left-color: var(--accent-primary);
        }

        .aircraft-callsign {
            font-weight: bold;
            color: var(--text-accent);
            margin-bottom: 3px;
        }

        .aircraft-details {
            color: var(--text-secondary);
            font-size: 11px;
        }

        /* Aircraft Badges */
        .badge {
            padding: 2px 4px;
            border-radius: var(--badge-radius);
            font-size: 9px;
            margin-right: 4px;
            display: inline-block;
        }

        .badge-military {
            background: var(--badge-military);
            color: var(--badge-military-text);
            font-weight: bold;
        }

        .badge-mlat {
            background: var(--badge-mlat);
            color: var(--badge-mlat-text);
            opacity: 0.8;
        }

        .badge-stat {
            background: var(--badge-stat);
            color: var(--badge-stat-text);
        }

        #controls {
            position: absolute;
            bottom: 100px;  /* Higher to clear footer with altitude chart */
            left: 30px;    /* Mirror coffee button position */
            background: var(--panel-bg);
            padding: var(--panel-padding);
            border-radius: var(--panel-radius);
            backdrop-filter: var(--panel-blur);
            border: 1px solid var(--panel-border);
            font-size: var(--font-size-base);
            max-width: 300px;
            touch-action: auto;
            z-index: var(--z-panels);
        }

        #controls button {
            background: var(--accent-primary-dim);
            color: var(--text-primary);
            border: 1px solid var(--accent-primary-hover);
            padding: var(--spacing-sm) 16px;
            margin: 0 var(--spacing-xs);
            border-radius: var(--panel-radius);
            cursor: pointer;
            font-size: var(--font-size-base);
            transition: all 0.3s ease;
            backdrop-filter: var(--panel-blur);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #controls button:hover {
            background: var(--accent-primary-hover);
            border-color: var(--accent-primary-active);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--accent-primary-dim);
        }

        #controls button.active {
            background: var(--accent-primary-active);
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px var(--accent-primary-hover);
        }

        /* Mode Selector Buttons */
        .mode-selector {
            position: absolute;
            top: var(--spacing-xl);
            right: var(--spacing-xl);
            z-index: var(--z-panels);
            display: flex !important;
            gap: var(--spacing-sm);
            touch-action: auto;
        }

        .mode-btn {
            background: var(--mode-inactive-bg);
            color: var(--text-primary);
            border: 2px solid var(--mode-inactive-border);
            padding: var(--spacing-sm) 16px;
            border-radius: var(--button-radius);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: var(--panel-blur);
            box-shadow: var(--button-shadow);
        }

        .mode-btn:hover {
            background: var(--mode-inactive-hover-bg);
            border: 2px solid var(--mode-inactive-hover-border);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--mode-inactive-hover-border);
        }

        .mode-btn.active {
            background: var(--mode-active);
            color: var(--text-primary);
            border: 2px solid var(--mode-active-border);
            box-shadow: 0 0 15px var(--mode-active-glow);
        }

        .mode-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .mode-icon {
            margin-right: 4px;
        }

        /* Hide separate Quick Stats panel - stats are now inline in aircraft list */
        #mini-stats {
            display: none !important;
        }

        /* Historical Controls Styling */

        #historical-controls {
            position: absolute;
            top: 90px;  /* Align with aircraft-list */
            right: var(--spacing-xl);
            bottom: 90px;  /* Leave room for footer (footer is ~70-80px tall) */
            background: var(--panel-bg-solid);
            padding: 10px;  /* Reduced from var(--panel-padding) which is typically 15px */
            border-radius: var(--panel-radius);
            backdrop-filter: var(--panel-blur);
            width: 320px;  /* FIXED width - prevents expansion when buttons appear */
            min-width: 320px;
            max-width: 320px;
            height: auto;  /* Auto height between top and bottom constraints */
            max-height: none;  /* Let bottom constraint control max height */
            overflow-y: scroll;  /* Always show scrollbar track */
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;  /* Include padding in width calculation */
            z-index: 101;  /* Higher than aircraft-list to appear on top */
        }

        /* Custom scrollbar for historical controls */
        #historical-controls::-webkit-scrollbar {
            width: 8px;
        }

        #historical-controls::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        #historical-controls::-webkit-scrollbar-thumb {
            background: var(--accent-primary-dim);
            border-radius: 4px;
            border: 1px solid var(--accent-primary);
        }

        #historical-controls::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary-active);
        }

        /* Prevent any child element from exceeding panel width */
        #historical-controls * {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Compact historical controls styling */
        #historical-controls .panel-header {
            margin-bottom: 8px;
            padding-bottom: 6px;
        }

        #historical-controls h3 {
            font-size: 12px;  /* Reduced from 13px */
            margin: 6px 0 3px 0;  /* Tighter margins */
        }

        #historical-controls .controls-section {
            margin-bottom: 8px;  /* Reduced from 10px */
        }

        /* Reduce all margins/padding in display mode and filter sections */
        #display-mode-selector,
        #historical-filters,
        #playback-controls {
            margin-top: 10px !important;  /* Reduced from 15-20px */
            padding-top: 10px !important;  /* Reduced from 15px */
        }

        /* Filter tracks content - reduced padding */
        #filter-tracks-content {
            padding-bottom: 8px;
            margin-bottom: 6px;
        }

        .historical-input-group {
            margin-bottom: 8px;  /* Reduced from 12px */
        }

        .historical-input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 11px;  /* Reduced from 12px */
            margin-bottom: 3px;  /* Reduced from 4px */
        }

        .historical-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--accent-primary-dim);
            color: var(--text-primary);
            padding: 6px;  /* Reduced from 8px */
            border-radius: 4px;
            font-size: 12px;  /* Reduced from 13px */
        }

        .historical-input:focus {
            outline: none;
            border-color: var(--accent-primary-active);
            background: rgba(255, 255, 255, 0.15);
        }

        .historical-load-btn {
            width: 100%;
            background: var(--accent-primary-active);
            border: 1px solid var(--accent-primary);
            color: var(--text-primary);
            padding: 7px;  /* Reduced from 10px */
            border-radius: 4px;
            font-size: 12px;  /* Reduced from 14px */
            font-weight: bold;
            cursor: pointer;
            margin-top: 6px;  /* Reduced from 8px */
            transition: all 0.3s ease;
        }

        .historical-load-btn:hover {
            background: var(--accent-primary);
            box-shadow: 0 0 15px var(--accent-primary-active);
        }

        .historical-load-btn:active {
            transform: scale(0.98);
        }

        .historical-status {
            margin-top: 6px;  /* Reduced from 10px */
            padding: 6px;  /* Reduced from 8px */
            border-radius: 4px;
            font-size: 11px;  /* Reduced from 12px */
            text-align: center;
            min-height: 16px;  /* Reduced from 20px */
        }

        .historical-status.loading {
            color: var(--text-accent);
            background: var(--accent-primary-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .historical-status.success {
            color: var(--status-success);
            background: var(--status-success-bg);
        }

        .historical-status.error {
            color: var(--status-error);
            background: var(--status-error-bg);
        }

        .historical-status.warning {
            color: var(--status-warning);
            background: var(--status-warning-bg);
        }

        /* Loading Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--accent-primary-dim);
            border-top-color: var(--text-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Compact form elements in historical controls */
        #historical-controls input[type="radio"],
        #historical-controls input[type="checkbox"] {
            margin: 0 4px 0 0;
        }

        #historical-controls input[type="number"],
        #historical-controls input[type="range"] {
            padding: 4px 6px;
            font-size: 11px;
        }

        #historical-controls select {
            padding: 5px;
            font-size: 11px;
            max-width: 100%;
            box-sizing: border-box;
        }

        #historical-controls button {
            padding: 5px 8px !important;  /* Override inline styles */
            font-size: 10px !important;  /* Smaller for compact fit */
            margin: 3px 0;
            max-width: 100%;
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Display mode buttons - make ultra-compact */
        #display-mode-selector button {
            padding: 6px 4px !important;
            font-size: 10px !important;
            flex: 1 1 0 !important;  /* Equal width flex items */
            min-width: 0 !important;  /* Allow shrinking below content size */
        }

        /* Playback controls - compact layout */
        .playback-controls {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .playback-btn {
            flex: 1 1 auto;
            min-width: 60px;
        }

        .playback-btn-small {
            flex: 0 1 auto;
            padding: 4px 6px !important;
        }

        .playback-speed-select {
            flex: 0 0 auto;
            width: 60px !important;
        }

        /* Reduce spacing in filter sections */
        #historical-controls .filter-section {
            margin-bottom: 8px;
        }

        #historical-controls .filter-section label {
            margin-bottom: 3px;
        }

        /* Compact time range selector */
        #historical-controls .time-range-selector {
            margin-bottom: 8px;
        }

        #historical-controls .time-range-inputs {
            gap: 6px;
        }

        /* Mode transition effects */
        .mode-transition {
            transition: opacity 0.3s ease-in-out;
        }

        .mode-transition.fading {
            opacity: 0.3;
        }

        /* Status indicator */
        .api-status {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.85);
            padding: 6px 12px;
            border-radius: 14px;
            z-index: 100;
            border: 1px solid var(--accent-primary-dim);
        }

        .api-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-success);
            box-shadow: 0 0 8px var(--status-success-glow);
        }

        .api-status-dot.offline {
            background: var(--status-offline);
            box-shadow: none;
        }

        /* Small inline status dot for info panel */
        .api-status-dot-small {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-success);
            box-shadow: 0 0 6px var(--status-success-glow);
            margin-right: 6px;
            vertical-align: middle;
        }

        .api-status-dot-small.offline {
            background: var(--status-offline);
            box-shadow: none;
        }

        #api-status-inline {
            display: flex;
            align-items: center;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: var(--text-accent);
        }

        #aircraft-detail {
            position: absolute;
            bottom: 170px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            min-width: 400px;
            max-width: 500px;
            display: none;
            border: 2px solid var(--accent-primary);
            touch-action: auto; /* Allow normal touch on UI panels */
            overflow: hidden; /* Contain scrolling to body */
        }

        #aircraft-detail .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px 10px 20px;
            background: rgba(0, 0, 0, 0.85);
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
            flex-shrink: 0; /* Don't shrink when body scrolls */
        }

        #aircraft-detail h3 {
            color: var(--text-accent);
            margin: 0;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            padding-right: 10px;
        }

        #aircraft-detail .detail-body {
            padding: 15px 20px;
            overflow-y: auto;
            max-height: 60vh; /* Limit height for scrolling */
        }

        #aircraft-detail .detail-grid {
            display: grid;
            grid-template-columns: 110px 1fr;
            gap: 6px;
            font-size: 12px;
            line-height: 1.4;
        }

        #aircraft-detail .detail-label {
            color: var(--text-secondary);
            font-size: 11px;
        }

        #aircraft-detail .detail-value {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 12px;
            word-break: break-word;
        }

        #aircraft-detail .close-btn {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            flex-shrink: 0;
        }

        #aircraft-detail .close-btn:hover {
            color: var(--text-accent);
        }

        #unfollow-btn {
            display: none;
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(255, 68, 68, 1);
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        #unfollow-btn:hover {
            background: rgba(255, 40, 40, 1);
            border-color: rgba(255, 20, 20, 1);
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.5);
        }

        #altitude-chart {
            display: none; /* Hidden - now in footer */
        }

        #altitude-chart .chart-title {
            color: var(--text-accent);
            font-size: 11px;  /* Smaller title */
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;  /* Small gap below title */
        }

        #altitude-chart .gradient-bar {
            height: 20px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(to right,
                hsl(0, 0%, 45%) 0%,
                hsl(20, 88%, 44%) 5%,
                hsl(40, 88%, 44%) 10%,
                hsl(60, 88%, 44%) 15%,
                hsl(80, 88%, 44%) 20%,
                hsl(100, 88%, 44%) 25%,
                hsl(120, 88%, 44%) 30%,
                hsl(140, 88%, 44%) 35%,
                hsl(160, 88%, 44%) 45%,
                hsl(180, 88%, 44%) 55%,
                hsl(200, 88%, 44%) 65%,
                hsl(220, 88%, 44%) 75%,
                hsl(240, 88%, 44%) 80%,
                hsl(260, 88%, 44%) 85%,
                hsl(280, 88%, 44%) 90%,
                hsl(300, 88%, 44%) 95%,
                hsl(300, 88%, 44%) 100%
            );
        }

        #altitude-chart .labels {
            display: flex;
            justify-content: space-between;
            color: var(--modal-text-strong);
            font-size: 10px;
            padding: 0 2px;
        }

        #altitude-chart .label-marker {
            position: relative;
            text-align: center;
        }

        /* Enhanced aircraft list item hover */
        .aircraft-item {
            transition: all 0.3s ease;
        }

        /* Mini Radar View */
        #mini-radar {
            position: absolute;
            bottom: 170px;  /* Below compass with more spacing */
            right: 30px;
            width: 150px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent-primary-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #radar-canvas {
            width: 150px;
            height: 150px;
            display: block;
        }

        /* Compass rose overlay */
        #compass-rose {
            position: absolute;
            bottom: 340px;
            right: 30px;
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent-primary-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #compass-rose .direction {
            position: absolute;
            text-align: center;
        }

        #compass-rose .direction.n {
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--compass-north);
            font-size: 16px;
        }

        #compass-rose .direction.s {
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        #compass-rose .direction.e {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        #compass-rose .direction.w {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        #compass-rose .center-dot {
            width: 6px;
            height: 6px;
            background: var(--text-accent);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--text-accent);
        }

        /* Mini statistics panel */
        #mini-stats {
            position: absolute;
            bottom: 340px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 16px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--accent-primary-dim);
            font-size: 11px;
            min-width: 180px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            touch-action: auto; /* Allow normal touch on UI panels */
        }

        #mini-stats h4 {
            color: var(--text-accent);
            margin: 0 0 8px 0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #mini-stats .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #mini-stats .stat-row:last-child {
            border-bottom: none;
        }

        #mini-stats .stat-label {
            color: var(--text-secondary);
        }

        #mini-stats .stat-value {
            color: var(--text-primary);
            font-weight: bold;
        }

        /* Keyboard shortcut hint */
        .keyboard-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
            font-size: 10px;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .keyboard-hint.show {
            opacity: 1;
        }

        .keyboard-hint kbd {
            background: var(--accent-primary-dim);
            border: 1px solid var(--accent-primary-hover);
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            color: var(--text-accent);
            margin: 0 2px;
        }

        /* Collapseable Panel Styles */
        .collapseable-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .collapseable-panel .panel-header h1,
        .collapseable-panel .panel-header h2,
        .collapseable-panel .panel-header h4 {
            margin: 0;
            flex-grow: 1;
            font-weight: var(--font-weight-headers);
        }

        .collapseable-panel .panel-header .controls-title {
            color: var(--text-accent);
            font-size: var(--font-size-large);
            font-weight: bold;
            letter-spacing: 0.5px;
            white-space: nowrap;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .collapse-btn {
            background: var(--accent-primary-dim);
            border: var(--panel-border-width) solid var(--accent-primary-hover);  /* Match theme border width */
            color: var(--text-accent);
            width: 24px;
            height: 24px;
            border-radius: var(--button-radius);  /* Respect theme styling */
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-left: 10px;
            margin-right: 0;
        }

        .collapse-btn:hover {
            background: var(--accent-primary-hover);
            border-color: var(--accent-primary-active);
        }

        .collapseable-panel.collapsed .panel-content {
            display: none !important;
        }

        .collapseable-panel.collapsed .collapse-btn {
            transform: rotate(180deg);
        }

        /* Panel header as button (like mode buttons) */
        .panel-header-btn {
            width: 100%;
            background: transparent;
            color: var(--text-primary);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .panel-header-btn:hover {
            background: rgba(74, 158, 255, 0.15);
        }

        .panel-header-btn .collapse-indicator {
            font-size: 16px;
            transition: transform 0.3s ease;
            margin-left: 8px;
            margin-right: 4px;  /* Add breathing room on the right */
            color: var(--text-accent);
        }

        .collapseable-panel.collapsed .panel-header-btn .collapse-indicator {
            transform: rotate(180deg);
        }

        .collapseable-panel.collapsed .panel-header {
            margin-bottom: 0;
        }

        /* Ensure controls panel collapses properly */
        #controls.collapseable-panel.collapsed .panel-content {
            display: none !important;
        }

        /* Ensure historical-controls panel collapses properly */
        #historical-controls.collapseable-panel.collapsed .panel-content {
            display: none !important;
        }

        /* Collapse historical-controls panel height when collapsed */
        #historical-controls.collapseable-panel.collapsed {
            bottom: auto !important;
            height: auto !important;
        }

        /* Adjust info panel header for flex layout */
        #info .panel-header h1 {
            font-size: 18px;
            color: var(--text-accent);
        }

        /* Adjust aircraft-list header for flex layout */
        #aircraft-list .panel-header h2 {
            font-size: 16px;
            color: var(--text-accent);
        }

        /* Controls panel header matches aircraft-list */
        #controls .panel-header h2 {
            font-size: 16px;
            color: var(--text-accent);
        }

        /* Adjust mini-stats header for flex layout */
        #mini-stats .panel-header h4 {
            color: var(--text-accent);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Adjust controls panel for collapseable */
        #controls.collapseable-panel {
            padding: 0;  /* No outer padding - let panel-header handle spacing */
        }

        #controls.collapseable-panel .panel-header {
            padding: 10px 15px;  /* Panel header has padding */
            margin-bottom: 0;
        }

        #controls.collapseable-panel .panel-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-md);
            padding: 0 15px 10px 15px;  /* Content padding (no top since header has bottom) */
        }

        /* Toggle Switch Styles */
        .toggle-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch-container:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .toggle-switch-label {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            user-select: none;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch-container.active .toggle-switch {
            background: var(--accent-primary);
        }

        .toggle-switch-container.active .toggle-switch::after {
            transform: translateX(20px);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Compact footer on mobile */
            #footer-bar {
                padding: 6px 10px;
                font-size: 11px;
                gap: 4px;
            }

            #footer-altitude {
                max-width: 100%;
                padding: 0 4px;
            }

            #footer-altitude .altitude-label {
                font-size: 9px;
            }

            #footer-altitude .gradient-bar {
                height: 14px;
            }

            #footer-altitude .labels {
                font-size: 8px;
                padding: 0 20px;
            }

            #footer-links {
                font-size: 10px;
            }

            /* Hide standalone altitude chart on mobile */
            #altitude-chart {
                display: none !important;
            }

            /* Info panel on mobile - align to right like historical controls */
            #info {
                top: 50px !important;  /* Below mode selector buttons */
                right: 10px !important;  /* Align to right edge */
                left: auto !important;  /* Don't set left - let it size naturally */
                max-width: 200px !important;  /* Compact width on mobile */
                min-width: 0 !important;
                font-size: 12px;
                padding: 8px !important;
                margin: 0 !important;
                border: 1px solid var(--panel-border) !important;
            }

            #info h1 {
                font-size: 14px;
            }

            /* When expanded on mobile, allow wider */
            #info:not(.collapsed):not(.mobile-collapsed) {
                max-width: calc(100vw - 20px);
            }

            #aircraft-list {
                /* Override utility class - align to RIGHT only, not full width */
                top: 50px !important;
                right: 10px !important;
                left: auto !important;  /* Don't span full width */
                max-width: calc(100vw - 20px) !important;  /* Allow expanding but not full width */
                min-width: 200px !important;  /* Minimum compact size */
                max-height: calc(60vh - 80px);  /* More room with footer-integrated altitude */
                font-size: 11px;
                padding: 8px !important;
                margin: 0 !important;
                z-index: 100;  /* Ensure visible */
                /* display controlled by JavaScript mode switching - don't override */
            }

            #aircraft-list h2 {
                font-size: 14px;
            }

            .aircraft-item {
                padding: 6px 8px;
                font-size: 11px;
            }

            #mini-stats {
                min-width: 150px;
                font-size: 10px;
                padding: 10px 12px;
            }

            #controls {
                top: auto;
                left: 10px;
                right: auto;  /* Don't stretch full width */
                bottom: 100px;  /* Above footer */
                transform: none;
                max-width: none;  /* Allow to expand properly */
                width: auto;  /* Auto width */
                padding: 0;  /* No outer padding */
                pointer-events: auto;
                z-index: 105;  /* Higher than other elements */
            }

            #controls .panel-header-btn {
                margin: 0;
                padding-right: 6px;
            }

            /* When collapsed, constrain width */
            #controls.collapsed,
            #controls.mobile-collapsed {
                max-width: 120px;
            }

            /* Ensure collapsed controls don't block canvas */
            #controls.collapsed {
                pointer-events: none;
            }

            #controls.collapsed .panel-header,
            #controls.collapsed .panel-header-btn {
                pointer-events: auto;
            }

            /* Match mode button styling exactly */
            #controls.collapseable-panel .panel-header {
                padding: 6px 8px;  /* Panel header padding for mobile - reduced right padding */
                margin: 0;
                min-width: 0;  /* Allow flex to compress properly */
            }

            #controls.collapseable-panel .panel-header .controls-title {
                min-width: 0;  /* Allow title to compress on mobile */
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #controls.collapseable-panel .collapse-btn {
                margin-left: 8px;  /* Reduced from 10px for mobile space */
                margin-right: 0;
                flex-shrink: 0;
            }

            #controls.collapseable-panel .panel-content {
                padding: 0 10px 6px 10px;  /* Content padding for mobile */
            }

            #controls button {
                padding: 5px 8px;  /* Match mode button size */
                font-size: 10px;
                margin: 0 2px;
            }

            /* Collapse panels by default on mobile */
            .collapseable-panel.mobile-collapsed .panel-content {
                display: none !important;
            }

            .collapseable-panel.mobile-collapsed .collapse-btn {
                transform: rotate(180deg);
            }

            /* Make detail panel full width on mobile */
            #aircraft-detail {
                max-width: calc(100vw - 40px);
                min-width: calc(100vw - 40px);
                width: auto;
                left: 20px;
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
            }

            #aircraft-detail .detail-header {
                padding: 8px 10px;
            }

            #aircraft-detail h3 {
                font-size: 13px;
            }

            #aircraft-detail .detail-body {
                padding: 10px;
                max-height: calc(70vh - 50px); /* Subtract header height */
            }

            #aircraft-detail .detail-grid {
                font-size: 10px;
                gap: 4px;
                grid-template-columns: 90px 1fr;
                line-height: 1.3;
            }

            #aircraft-detail .detail-label {
                font-size: 9px;
            }

            #aircraft-detail .detail-value {
                font-size: 10px;
            }

            #aircraft-detail .close-btn {
                font-size: 18px;
                padding: 2px 8px;
            }

            #aircraft-detail #detail-follow-btn {
                margin-top: 10px;
                padding: 6px 12px;
                font-size: 11px;
            }

            /* Adjust altitude chart for mobile - compact and always visible */
            #altitude-chart {
                bottom: 32px;  /* Higher above footer */
                left: 50%;
                transform: translateX(-50%);
                min-width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
                padding: 6px 8px;  /* Even more compact on mobile */
                font-size: 9px;
            }

            #altitude-chart .chart-title {
                font-size: 10px;
                margin-bottom: 3px;
            }

            #altitude-chart .gradient-bar {
                height: 14px;  /* Shorter on mobile */
            }

            /* Historical controls on mobile - positioning handled by utility classes */
            #historical-controls {
                /* Positioning handled by .mobile-panel-aligned utility class */
            }

            /* Mode selector on mobile - move to top right, smaller */
            #mode-selector {
                top: 10px;
                right: 10px;
                left: auto;
                flex-direction: row;
                gap: 4px;
                z-index: 110;  /* Above other panels */
            }

            .mode-btn {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 60px;
            }

            /* Mini radar on mobile - smaller and below compass */
            #mini-radar {
                bottom: 80px;  /* Above footer (40px footer + 40px clearance) */
                right: 10px;
                width: 90px;
                height: 90px;
                opacity: 0.7;
            }

            #radar-canvas {
                width: 90px;
                height: 90px;
            }

            /* Keep compass rose visible on mobile - moved to bottom right */
            #compass-rose {
                bottom: 180px;  /* Above radar (80px + 90px radar + 10px spacing) */
                right: 10px;
                width: 60px;
                height: 60px;
                opacity: 0.7;  /* Slightly transparent on mobile */
            }

            /* Make modals mobile-friendly */
            #about-content,
            #keyboard-help-modal .modal-content {
                max-width: calc(100vw - 40px);
                padding: 20px;
                margin: 0 20px;
            }

            #about-content h2 {
                font-size: 22px;
            }

            #about-content p,
            #keyboard-help-modal p {
                font-size: 13px;
            }

            /* Unfollow button on mobile */
            #unfollow-btn {
                bottom: 110px;
                padding: 6px 16px;
                font-size: 12px;
            }

            /* Mini-stats tighter spacing on mobile */
            #mini-stats h4 {
                font-size: 11px;
                margin: 0 0 6px 0;
            }

            #mini-stats .stat-row {
                margin: 3px 0;
                padding: 2px 0;
            }

            /* Info panel stats tighter spacing */
            #info .stat {
                margin: 4px 0;
                font-size: 11px;
            }

            #info .stat .label {
                font-size: 10px;
            }

            #info .stat .value {
                font-size: 11px;
            }

            /* Historical controls - extra compact on mobile, right-aligned */
            #historical-controls {
                /* Override .mobile-panel-aligned - right align instead of full width */
                top: 50px !important;
                bottom: 90px !important;  /* Leave room for footer */
                right: 10px !important;
                left: auto !important;  /* Don't span full width */
                width: 320px !important;  /* Fixed width to prevent expansion when buttons appear */
                max-width: 320px !important;  /* Compact width */
                min-width: 0 !important;
                height: auto !important;  /* Auto height between top and bottom */
                max-height: none !important;  /* Let bottom constraint control */
                padding: 6px !important;
                margin: 0 !important;
                font-size: 9px;
                overflow-y: scroll !important;  /* Always show scrollbar */
                box-sizing: border-box;  /* Include padding in width calculation */
            }

            /* Mobile scrollbar styling */
            #historical-controls::-webkit-scrollbar {
                width: 6px;
            }

            #historical-controls::-webkit-scrollbar-thumb {
                background: var(--accent-primary);
                border-radius: 3px;
            }

            /* Consistent panel header styling on mobile */
            #historical-controls .panel-header,
            #aircraft-list .panel-header,
            #controls .panel-header {
                margin-bottom: 3px;
                padding: 4px;
            }

            #historical-controls .controls-title,
            #aircraft-list .controls-title,
            #controls .controls-title {
                font-size: 11px;
                margin-bottom: 0;
                white-space: nowrap;
                flex-shrink: 0;
            }

            #historical-controls label {
                font-size: 9px;
                margin-bottom: 1px;
                display: block;
            }

            #historical-controls input,
            #historical-controls select,
            #historical-controls button {
                padding: 3px 5px;
                font-size: 9px;
                margin: 1px 0;
                width: 100%;
                box-sizing: border-box;  /* Include padding in width */
            }

            /* Ensure radio button grid doesn't overflow */
            #historical-controls input[type="radio"] {
                width: auto !important;
                flex-shrink: 0;
            }

            /* Ensure display mode buttons fit within fixed width */
            #historical-controls #display-mode-selector button {
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            #historical-controls .time-range-inputs {
                gap: 3px;
            }

            #historical-controls .filter-section {
                margin-top: 4px;
                padding-top: 4px;
            }

            #historical-controls .historical-input-group {
                margin-bottom: 4px;
            }

            /* Filter tracks content - padding for visibility on mobile */
            #filter-tracks-content {
                padding-bottom: 20px;
                margin-bottom: 10px;
            }

            #historical-controls .historical-status {
                padding: 3px;
                font-size: 8px;
                margin-top: 4px;
            }

            #historical-controls .collapse-btn {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }

            /* Toggle switch containers tighter on mobile */
            .toggle-switch-container {
                padding: 6px;
            }

            .toggle-switch-label {
                font-size: 10px;
            }

            .toggle-switch {
                width: 36px;
                height: 18px;
            }

            .toggle-switch::after {
                width: 14px;
                height: 14px;
            }

            /* Collapse button mobile sizing */
            .collapse-btn {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            /* About modal content spacing */
            #about-content h3 {
                font-size: 14px;
                margin: 15px 0 8px 0;
            }

            #about-content ul {
                margin: 8px 0;
                padding-left: 20px;
            }

            #about-content li {
                margin: 4px 0;
                font-size: 12px;
            }

            .feature-list {
                line-height: 1.4;
            }

            .version,
            .author {
                font-size: 11px;
                margin: 4px 0;
            }

            /* Keyboard help modal */
            #keyboard-help-modal .modal-content {
                padding: 15px;
            }

            #keyboard-help-modal h2 {
                font-size: 18px;
                margin-bottom: 10px;
            }

            #keyboard-help-modal h3 {
                font-size: 14px;
                margin: 12px 0 6px 0;
            }

            #keyboard-help-modal .shortcut-group {
                margin-bottom: 10px;
            }

            #keyboard-help-modal .shortcut-item {
                padding: 4px 0;
                font-size: 11px;
            }

            #keyboard-help-modal kbd {
                padding: 2px 6px;
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens - Pixel 7 Pro and similar */
            #info {
                top: 50px !important;  /* Below mode selector */
                left: auto !important;
                right: 10px !important;
                padding: 8px !important;
                max-width: 180px;
            }

            #aircraft-list {
                /* Positioning handled by .mobile-panel-aligned utility class (480px) */
            }

            #mini-stats {
                left: 10px;
                max-width: 180px;
                bottom: 110px;
            }

            #controls {
                bottom: 100px;  /* Above footer */
                padding: 0;  /* No outer padding */
            }

            #controls button {
                padding: 5px 8px;
                font-size: 9px;
            }
        }

        /* Touch-friendly tap targets */
        @media (hover: none) and (pointer: coarse) {
            /* Increase tap target sizes for touch devices */
            .collapse-btn {
                width: 32px;
                height: 32px;
            }

            #controls button {
                padding: 10px 14px;
                margin: 0 3px;
            }

            .aircraft-item {
                padding: 10px;
                margin: 6px 0;
            }

            .close-btn {
                width: 36px;
                height: 36px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <!-- About Modal -->
    <div id="about-modal">
        <div id="about-content">
            <button class="close-btn" id="close-about">×</button>
            <h2>ADS-B 3D - Unified Viewer</h2>
            <p class="version">Version 2.0.0</p>
            <p class="author">Created by <strong>hook-365</strong></p>

            <p>
                Real-time and historical 3D visualization of ADS-B aircraft data.
                View live aircraft, replay historical tracks, and explore flight patterns
                in an immersive 3D environment with accurate airport and runway overlays.
            </p>

            <h3>Live Mode</h3>
            <ul class="feature-list">
                <li>Real-time 3D aircraft visualization</li>
                <li>Altitude-based color gradient (red→orange→green→magenta)</li>
                <li>Flight path trails with recent history (1-30 min)</li>
                <li>Military aircraft detection & highlighting</li>
                <li>Interactive aircraft selection & follow mode</li>
                <li>Live statistics dashboard</li>
            </ul>

            <h3>Historical Mode</h3>
            <ul class="feature-list">
                <li>Time travel: replay past 6+ days of flights</li>
                <li>Quick presets: 1, 4, 8, 12, 24 hours or custom range</li>
                <li>Post-load filters: military, altitude, track length, speed</li>
                <li>MLAT altitude smoothing (fixes zero-altitude glitches)</li>
                <li>Optimized rendering (instanced endpoints)</li>
                <li>Same altitude colors as live mode</li>
            </ul>

            <h3>Common Features</h3>
            <ul class="feature-list">
                <li>Airport & runway overlays (2000+ airports)</li>
                <li>Keyboard shortcuts (R, T, L, A, H)</li>
                <li>Distance rings & home location marker</li>
                <li>Smooth mode switching with fade transitions</li>
                <li>Responsive design (desktop & mobile)</li>
            </ul>

            <h3>Data Sources</h3>
            <p class="data-source">
                <strong>Live ADS-B Data:</strong><br>
                <a href="https://github.com/sdr-enthusiasts/docker-adsb-ultrafeeder" target="_blank" rel="noopener noreferrer">Ultrafeeder</a> -
                ADS-B receiver with MLAT support
            </p>
            <p class="data-source">
                <strong>Historical Data:</strong><br>
                Custom Track API with TimescaleDB - 6+ days of position history
            </p>
            <p class="data-source">
                <strong>Military Aircraft Database:</strong><br>
                <a href="https://github.com/Mictronics/readsb-protobuf" target="_blank" rel="noopener noreferrer">tar1090-db</a> (Mictronics) -
                Verified military aircraft ICAO codes
            </p>
            <p class="data-source">
                <strong>Airport & Runway Data:</strong><br>
                <a href="https://ourairports.com/data/" target="_blank" rel="noopener noreferrer">OurAirports</a> -
                Open data for 2000+ airports and runways worldwide
            </p>
            <p class="data-source">
                <strong>Flight Routes:</strong><br>
                <a href="https://www.adsbdb.com/" target="_blank" rel="noopener noreferrer">adsbdb.com</a> -
                Free public API for flight routes and airline data<br>
                <span class="note">Note: Route data shows typical scheduled routes for flight numbers, not real-time flight plans.</span>
            </p>
            <p class="data-source">
                <strong>Aircraft Photos:</strong><br>
                <a href="https://airport-data.com/" target="_blank" rel="noopener noreferrer">Airport-Data.com</a> -
                Aircraft photography database
            </p>
            <p class="data-source">
                <strong>Map Tiles:</strong><br>
                <a href="https://carto.com/basemaps/" target="_blank" rel="noopener noreferrer">CartoDB Dark Matter</a> -
                Dark-themed basemap by CARTO
            </p>
            <p class="data-source">
                <strong>3D Graphics:</strong><br>
                • <a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">Three.js</a> - WebGL 3D rendering library
            </p>
            <p class="note" style="margin-top: 8px;">
                Note: Ground plane uses flat 2D map tiles - no 3D elevation data.
            </p>

            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <a href="#" class="github-link disabled" id="github-link">
                    📦 GitHub Repository (Coming Soon)
                </a>
                <a href="https://buymeacoffee.com/anthonyhook" class="github-link" target="_blank" rel="noopener noreferrer">
                    ☕ Buy me a coffee
                </a>
            </div>
        </div>
    </div>

    <div id="aircraft-list" class="collapseable-panel mobile-panel-aligned mobile-compact-padding">
        <div class="panel-header">
            <span class="controls-title">🛩️ ADS-B 3D</span>
            <button class="collapse-btn" data-panel="aircraft-list" title="Collapse panel">−</button>
        </div>
        <div class="panel-content">
            <!-- Quick Stats (consolidated) -->
            <div class="stat">
                <span class="label">Aircraft:</span>
                <span class="value" id="aircraft-count">0</span>
            </div>
            <div class="stat">
                <span class="label">Updated:</span>
                <span class="value" id="last-update">--</span>
            </div>

            <!-- Live Mode Options Section (shown when Track API available and in live mode) -->
            <div id="live-mode-options-section" style="display: none;">
                <div style="border-top: 1px solid rgba(74, 158, 255, 0.2); margin: 12px 0;"></div>
                <div class="section-label">Options</div>
                <div class="historical-input-group">
                    <label for="enable-recent-trails" style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="enable-recent-trails" checked style="width: auto; margin: 0;">
                        <span>Pre-load recent trails:</span>
                        <select id="recent-trails-time" style="background: rgba(74, 158, 255, 0.1); border: 1px solid rgba(74, 158, 255, 0.3); color: var(--text-primary); padding: 2px 5px; border-radius: var(--input-radius); font-size: 12px;">
                            <option value="1">1 min</option>
                            <option value="5" selected>5 min</option>
                            <option value="10">10 min</option>
                            <option value="15">15 min</option>
                            <option value="30">30 min</option>
                            <option value="45">45 min</option>
                            <option value="60">1 hour</option>
                        </select>
                    </label>
                </div>
                <div class="historical-input-group" style="margin-top: 8px;">
                    <label for="enable-tron-mode" style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="enable-tron-mode" style="width: auto; margin: 0;">
                        <span>Tron mode</span>
                    </label>
                </div>
                <div id="recent-trails-status" class="historical-status" style="margin-top: 6px; min-height: 0;"></div>
            </div>

            <div style="border-top: 1px solid rgba(74, 158, 255, 0.2); margin: 8px 0 10px 0;"></div>
            <div class="section-label" style="margin-bottom: 10px;">Nearby Aircraft</div>
            <div id="aircraft-items"></div>
        </div>
    </div>

    <!-- Unfollow Button (shown when following an aircraft) -->
    <button id="unfollow-btn">✕ Unfollow</button>

    <div id="altitude-chart">
        <div class="chart-title">Altitude (ft)</div>
        <div class="gradient-bar"></div>
        <div class="labels">
            <span>0</span>
            <span>2k</span>
            <span>5k</span>
            <span>10k</span>
            <span>20k</span>
            <span>30k</span>
            <span>40k+</span>
        </div>
    </div>

    <!-- Mode Selector (Live vs Historical) -->
    <div id="mode-selector" class="mode-selector">
        <button id="live-mode-btn" class="mode-btn active" data-mode="live" title="Real-time aircraft tracking">
            <span class="mode-icon">📡</span> Live
        </button>
        <button id="historical-mode-btn" class="mode-btn" data-mode="historical" title="Historical track playback" style="display: none;">
            <span class="mode-icon">🕐</span> Historical
        </button>
    </div>

    <!-- Historical Controls (hidden by default, shown when historical mode active) -->
    <div id="historical-controls" class="collapseable-panel mobile-panel-aligned mobile-compact-padding" style="display: none;">
        <div class="panel-header">
            <span class="controls-title">📊 Historical Data</span>
            <button class="collapse-btn" data-panel="historical-controls" title="Collapse panel">−</button>
        </div>
        <div class="panel-content">
            <!-- Time Range Selection -->
            <div style="margin-bottom: 15px;">
                <label class="label-bold">Time Range:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="time-preset" value="1" checked style="width: auto; margin: 0;">
                        <span style="font-size: 12px;">Last 1 hour</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="time-preset" value="4" style="width: auto; margin: 0;">
                        <span style="font-size: 12px;">Last 4 hours</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="time-preset" value="8" style="width: auto; margin: 0;">
                        <span style="font-size: 12px;">Last 8 hours</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="time-preset" value="12" style="width: auto; margin: 0;">
                        <span style="font-size: 12px;">Last 12 hours</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="time-preset" value="24" style="width: auto; margin: 0;">
                        <span style="font-size: 12px;">Last 24 hours</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="time-preset" value="custom" style="width: auto; margin: 0;">
                        <span style="font-size: 12px;">Custom</span>
                    </label>
                </div>
            </div>

            <!-- Custom Time Range (hidden by default) -->
            <div id="custom-time-range" style="display: none; margin-bottom: 15px;">
                <div class="historical-input-group">
                    <label for="start-time">Start Time:</label>
                    <input type="datetime-local" id="start-time" class="historical-input">
                </div>
                <div class="historical-input-group">
                    <label for="end-time">End Time:</label>
                    <input type="datetime-local" id="end-time" class="historical-input">
                </div>
            </div>

            <!-- Load Button -->
            <button id="load-historical-data" class="historical-load-btn">Load Data</button>
            <div id="historical-status" class="historical-status"></div>

            <!-- Display Mode Selector (shown after data is loaded) -->
            <div id="display-mode-selector" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(74, 158, 255, 0.2);">
                <label class="label-bold">Display Mode:</label>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <button id="display-mode-all" class="historical-load-btn active" style="flex: 1; padding: 8px 12px; font-size: 12px; background: var(--accent-primary-dim); border: 1px solid var(--accent-primary-hover);" title="Show all tracks at once (default)">
                        📊 Show All Tracks
                    </button>
                    <button id="display-mode-playback" class="historical-load-btn" style="flex: 1; padding: 8px 12px; font-size: 12px;" title="Animate tracks over time">
                        ▶️ Playback Mode
                    </button>
                </div>
                <div id="display-mode-description" class="help-text">
                    Showing all tracks at once. Click Playback Mode to animate tracks over time.
                </div>

                <!-- Tron Mode Toggle -->
                <div class="historical-input-group" style="margin-top: 10px;">
                    <label for="historical-tron-mode">
                        <input type="checkbox" id="historical-tron-mode" style="width: auto; margin-right: 5px;">
                        Tron Mode (altitude curtains)
                    </label>
                </div>
            </div>

            <!-- Post-Load Filters (shown after data is loaded) -->
            <div id="historical-filters" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(74, 158, 255, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="document.getElementById('filter-tracks-content').style.display = document.getElementById('filter-tracks-content').style.display === 'none' ? 'block' : 'none'; this.querySelector('.nested-collapse-btn').textContent = this.querySelector('.nested-collapse-btn').textContent === '−' ? '+' : '−';">
                    <label style="font-weight: bold; color: var(--text-accent); cursor: pointer;">Filter Tracks:</label>
                    <span class="nested-collapse-btn" style="color: var(--text-accent); font-size: 18px; user-select: none;">+</span>
                </div>
                <div id="filter-tracks-content" style="display: none;">

                <!-- Military Only -->
                <div class="historical-input-group">
                    <label for="filter-military-only">
                        <input type="checkbox" id="filter-military-only" style="width: auto; margin-right: 5px;">
                        Military Only
                    </label>
                </div>

                <!-- Altitude Range -->
                <div class="historical-input-group">
                    <label for="filter-altitude-min">Min Altitude (ft):</label>
                    <input type="number" id="filter-altitude-min" class="historical-input" min="0" max="50000" step="1000" placeholder="0">
                </div>
                <div class="historical-input-group">
                    <label for="filter-altitude-max">Max Altitude (ft):</label>
                    <input type="number" id="filter-altitude-max" class="historical-input" min="0" max="50000" step="1000" placeholder="50000">
                </div>

                <!-- Minimum Track Length -->
                <div class="historical-input-group">
                    <label for="filter-min-positions">Min Positions:</label>
                    <input type="number" id="filter-min-positions" class="historical-input" min="2" max="1000" value="10" title="Hide tracks with fewer than this many positions">
                </div>

                <!-- Speed Range -->
                <div class="historical-input-group">
                    <label for="filter-speed-min">Min Speed (kts):</label>
                    <input type="number" id="filter-speed-min" class="historical-input" min="0" max="1000" step="50" placeholder="0">
                </div>
                <div class="historical-input-group">
                    <label for="filter-speed-max">Max Speed (kts):</label>
                    <input type="number" id="filter-speed-max" class="historical-input" min="0" max="1000" step="50" placeholder="1000">
                </div>

                <button id="apply-filters" class="historical-load-btn" style="margin-top: 10px;">Apply Filters</button>
                </div>
            </div>

            <!-- Playback Controls (shown after data is loaded) -->
            <div id="playback-controls" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(74, 158, 255, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="document.getElementById('playback-content').style.display = document.getElementById('playback-content').style.display === 'none' ? 'block' : 'none'; this.querySelector('.nested-collapse-btn').textContent = this.querySelector('.nested-collapse-btn').textContent === '−' ? '+' : '−';">
                    <label style="font-weight: bold; color: var(--text-accent); cursor: pointer;">Playback:</label>
                    <span class="nested-collapse-btn" style="color: var(--text-accent); font-size: 18px; user-select: none;">−</span>
                </div>
                <div id="playback-content">

                <!-- Play/Pause and Speed Controls -->
                <div class="playback-controls">
                    <button id="play-pause-btn" class="historical-load-btn playback-btn" title="Play/Pause animation">Play</button>
                    <button id="restart-btn" class="historical-load-btn playback-btn-small" title="Restart from beginning">Restart</button>
                    <select id="playback-speed" class="historical-input playback-speed-select">
                        <option value="1">1x</option>
                        <option value="5">5x</option>
                        <option value="10" selected>10x</option>
                        <option value="30">30x</option>
                        <option value="60">60x</option>
                        <option value="120">120x</option>
                    </select>
                </div>

                <!-- Fade Tracks Option -->
                <div class="historical-input-group" style="margin-bottom: 10px;">
                    <label for="fade-tracks" title="How long tracks remain visible after their end time">Fade Tracks After:</label>
                    <select id="fade-tracks" class="historical-input">
                        <option value="0">Immediately (default)</option>
                        <option value="1800">30 minutes</option>
                        <option value="3600">1 hour</option>
                        <option value="7200">2 hours</option>
                        <option value="never">Never (accumulate all)</option>
                    </select>
                </div>
                <div class="help-text">
                    Controls how long tracks stay visible after their end time. "Never" accumulates all tracks, slowly populating the sky.
                </div>

                <!-- Timeline Scrubber -->
                <div style="margin-bottom: 8px;">
                    <input type="range" id="timeline-scrubber" class="timeline-scrubber" min="0" max="100" value="0" step="0.1" title="Drag to seek">
                </div>

                <!-- Time Display -->
                <div class="timeline-times">
                    <span id="current-time-display">00:00:00</span>
                    <span id="total-time-display">00:00:00</span>
                </div>

                <!-- Playback Status -->
                <div id="playback-status" class="playback-status"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="controls" class="collapseable-panel">
        <div class="panel-header">
            <span class="controls-title">⚙️ Settings</span>
            <button class="collapse-btn" data-panel="controls" title="Collapse panel">−</button>
        </div>
        <div class="panel-content">
            <!-- Reset Camera Button (action button, not toggle) -->
            <button id="reset-camera" class="action-btn">↻ Reset Camera</button>

            <!-- Themes Button -->
            <button id="show-themes" class="action-btn">🎨 Themes</button>

            <!-- Toggle Switches -->
            <div class="toggle-switch-container active" id="toggle-trails-container">
                <span class="toggle-switch-label">Trails</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-labels-container">
                <span class="toggle-switch-label">Labels</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-airports-container">
                <span class="toggle-switch-label">Airports</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-runways-container">
                <span class="toggle-switch-label">Runways</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-altitude-lines-container">
                <span class="toggle-switch-label">Alt Lines</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-mini-radar-container">
                <span class="toggle-switch-label">Mini Radar</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-compass-container">
                <span class="toggle-switch-label">Compass</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container" id="toggle-trail-fade-container">
                <span class="toggle-switch-label">Auto-fade Trails</span>
                <div class="toggle-switch"></div>
            </div>

            <!-- Trail Fade Time Selector (shown when auto-fade is enabled) -->
            <div id="trail-fade-time-selector" style="display: none; margin-top: 8px;">
                <label for="trail-fade-time" style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Fade after:</label>
                <select id="trail-fade-time" style="width: 100%; padding: 6px; background: var(--panel-bg); color: var(--text-primary); border: 1px solid var(--panel-border); border-radius: var(--input-radius); font-size: 12px;">
                    <option value="1800">30 minutes</option>
                    <option value="3600" selected>1 hour</option>
                    <option value="7200">2 hours</option>
                    <option value="0">Never</option>
                </select>
            </div>

            <!-- Keyboard Help Button -->
            <button id="show-keyboard-help" class="secondary-btn">⌨️ Keyboard Shortcuts</button>
        </div>
    </div>

    <div id="aircraft-detail">
        <div class="detail-header">
            <h3 id="detail-callsign">Aircraft Details</h3>
            <button class="close-btn" id="close-detail">×</button>
        </div>
        <div class="detail-body">
            <div class="detail-grid" id="detail-content"></div>
            <button id="detail-follow-btn" class="full-width-btn">
                📍 Follow Aircraft
            </button>
        </div>
    </div>

    <div class="loading" id="loading">Loading...</div>

    <!-- Compass Rose -->
    <div id="compass-rose">
        <div class="direction n">N</div>
        <div class="direction s">S</div>
        <div class="direction e">E</div>
        <div class="direction w">W</div>
        <div class="center-dot"></div>
    </div>

    <!-- Mini Radar View -->
    <div id="mini-radar">
        <canvas id="radar-canvas" width="150" height="150"></canvas>
    </div>

    <!-- Mini Statistics Panel -->
    <div id="mini-stats" class="collapseable-panel">
        <div class="panel-header">
            <h4>Quick Stats</h4>
            <button class="collapse-btn" data-panel="mini-stats" title="Collapse panel">−</button>
        </div>
        <div class="panel-content">
            <div class="stat-row">
                <span class="stat-label">Highest:</span>
                <span class="stat-value" id="stat-highest">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Fastest:</span>
                <span class="stat-value" id="stat-fastest">--</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Closest:</span>
                <span class="stat-value" id="stat-closest">--</span>
            </div>
        </div>
    </div>

    <!-- Keyboard Hint (shows briefly on keypress) -->
    <div class="keyboard-hint" id="keyboard-hint"></div>

    <!-- Keyboard Help Modal -->
    <!-- Keyboard Help Sidebar (NEW) -->
    <div id="keyboard-help-overlay"></div>
    <div id="keyboard-help-sidebar">
        <div class="header">
            <h2>⌨️ Keyboard Shortcuts</h2>
            <button class="close-btn-help" id="close-keyboard-help-sidebar">×</button>
        </div>
        <div class="content">
            <!-- Camera Controls -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">📷 Camera</div>
                <div class="shortcut-item">
                    <kbd>R</kbd>
                    <div>
                        <div class="shortcut-desc">Reset Camera</div>
                        <div class="mode-indicator">Returns to home location</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>Scroll</kbd>
                    <div>
                        <div class="shortcut-desc">Zoom In/Out</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>Drag</kbd>
                    <div>
                        <div class="shortcut-desc">Rotate View</div>
                        <div class="mode-indicator">Click and drag with mouse</div>
                    </div>
                </div>
            </div>

            <!-- Toggle Displays -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">🎚️ Display Toggles</div>
                <div class="shortcut-item">
                    <kbd>T</kbd>
                    <div>
                        <div class="shortcut-desc">Trails</div>
                        <div class="mode-indicator">Flight path lines</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>L</kbd>
                    <div>
                        <div class="shortcut-desc">Labels</div>
                        <div class="mode-indicator">Aircraft callsigns</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>A</kbd>
                    <div>
                        <div class="shortcut-desc">Airports</div>
                        <div class="mode-indicator">Markers & details</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>H</kbd>
                    <div>
                        <div class="shortcut-desc">Runways</div>
                        <div class="mode-indicator">Airport runway overlays</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>V</kbd>
                    <div>
                        <div class="shortcut-desc">Altitude Lines</div>
                        <div class="mode-indicator">Reference altitude rings</div>
                    </div>
                </div>
            </div>

            <!-- Visual Effects -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">✨ Effects</div>
                <div class="shortcut-item">
                    <kbd>T</kbd>
                    <div>
                        <div class="shortcut-desc">Tron Mode</div>
                        <div class="mode-indicator">Altitude curtains (also in Settings)</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>C</kbd>
                    <div>
                        <div class="shortcut-desc">Compass</div>
                        <div class="mode-indicator">Direction indicator</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>M</kbd>
                    <div>
                        <div class="shortcut-desc">Mini Radar</div>
                        <div class="mode-indicator">Circle radar view</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">🧭 Navigation</div>
                <div class="shortcut-item">
                    <kbd>ESC</kbd>
                    <div>
                        <div class="shortcut-desc">Exit / Deselect</div>
                        <div class="mode-indicator">Close panels, stop following</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>?</kbd>
                    <div>
                        <div class="shortcut-desc">Help</div>
                        <div class="mode-indicator">Show this panel</div>
                    </div>
                </div>
            </div>

            <!-- Mobile Gestures -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">📱 Mobile Gestures</div>
                <div class="shortcut-item">
                    <kbd style="max-width: 100%;">Drag</kbd>
                    <div>
                        <div class="shortcut-desc">Rotate Camera</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd style="max-width: 100%; white-space: normal;">Pinch</kbd>
                    <div>
                        <div class="shortcut-desc">Zoom</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd style="max-width: 100%; white-space: normal;">Long-press</kbd>
                    <div>
                        <div class="shortcut-desc">Aircraft Menu</div>
                        <div class="mode-indicator">Quick actions</div>
                    </div>
                </div>
            </div>

            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--panel-border);">
                💡 <strong>Tip:</strong> Click any aircraft to select it. Press <kbd style="padding: 2px 4px;">ESC</kbd> to deselect.
            </p>
        </div>
    </div>

    <!-- Legacy Keyboard Help Modal (kept for compatibility) -->
    <div id="keyboard-help-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-btn" id="close-keyboard-help">×</button>
            <h2>Keyboard Shortcuts</h2>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; margin: 20px 0;">
                <kbd>R</kbd><span>Reset Camera</span>
                <kbd>T</kbd><span>Toggle Trails</span>
                <kbd>L</kbd><span>Toggle Labels</span>
                <kbd>A</kbd><span>Toggle Airports</span>
                <kbd>H</kbd><span>Toggle Runways</span>
                <kbd>V</kbd><span>Toggle Altitude Lines</span>
                <kbd>ESC</kbd><span>Close Modal / Exit Follow / Deselect</span>
                <kbd>?</kbd><span>Show This Help</span>
            </div>
            <p class="text-muted-sm" style="margin-top: 20px;">
                💡 <strong>Tip:</strong> Click any aircraft to select it, then press <kbd>ESC</kbd> to deselect.
            </p>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div id="theme-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-btn" id="close-theme-modal">×</button>
            <h2>Choose Theme</h2>
            <p style="margin-bottom: 20px; color: var(--text-secondary); font-size: 13px;">
                Select a color scheme for the interface. Your preference is saved automatically.
            </p>

            <div class="theme-grid">
                <!-- Modern Theme -->
                <div class="theme-card" data-theme="modern">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #4a9eff;"></div>
                        <div class="preview-color" style="background: #ffffff;"></div>
                        <div class="preview-color" style="background: #aaaaaa;"></div>
                    </div>
                    <h3>Modern</h3>
                    <p>Clean blue interface</p>
                    <div class="theme-active-indicator">✓ Active</div>
                </div>

                <!-- Digital Theme -->
                <div class="theme-card" data-theme="digital">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #00ff00;"></div>
                        <div class="preview-color" style="background: #00aa00;"></div>
                        <div class="preview-color" style="background: #004400;"></div>
                    </div>
                    <h3>Digital/CRT</h3>
                    <p>Green terminal</p>
                    <div class="theme-active-indicator">✓ Active</div>
                </div>

                <!-- Dark Theme -->
                <div class="theme-card" data-theme="dark">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #ffffff;"></div>
                        <div class="preview-color" style="background: #888888;"></div>
                        <div class="preview-color" style="background: #000000;"></div>
                    </div>
                    <h3>Dark Mode</h3>
                    <p>Pure black OLED</p>
                    <div class="theme-active-indicator">✓ Active</div>
                </div>

                <!-- Arctic Theme -->
                <div class="theme-card" data-theme="arctic">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #00d4ff;"></div>
                        <div class="preview-color" style="background: #88c9e0;"></div>
                        <div class="preview-color" style="background: #1a3344;"></div>
                    </div>
                    <h3>Arctic</h3>
                    <p>Cool icy blues</p>
                    <div class="theme-active-indicator">✓ Active</div>
                </div>

                <!-- Sunset Theme -->
                <div class="theme-card" data-theme="sunset">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #ff6b35;"></div>
                        <div class="preview-color" style="background: #cc9988;"></div>
                        <div class="preview-color" style="background: #442233;"></div>
                    </div>
                    <h3>Sunset</h3>
                    <p>Warm orange/purple</p>
                    <div class="theme-active-indicator">✓ Active</div>
                </div>

                <!-- Neon Theme -->
                <div class="theme-card" data-theme="neon">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #ff1493;"></div>
                        <div class="preview-color" style="background: #cc66dd;"></div>
                        <div class="preview-color" style="background: #440066;"></div>
                    </div>
                    <h3>Neon</h3>
                    <p>Synthwave pink</p>
                    <div class="theme-active-indicator">✓ Active</div>
                </div>

                <!-- Vintage Theme -->
                <div class="theme-card" data-theme="vintage">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #ffb000;"></div>
                        <div class="preview-color" style="background: #cc8800;"></div>
                        <div class="preview-color" style="background: #4a3f35;"></div>
                    </div>
                    <h3>Vintage</h3>
                    <p>Amber radar</p>
                    <div class="theme-active-indicator">✓ Active</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Footer Bar with Integrated Altitude Chart (Mobile) -->
    <div id="footer-bar">
        <div id="footer-altitude">
            <div class="altitude-content">
                <span class="altitude-label">Alt:</span>
                <div class="gradient-bar"></div>
            </div>
            <div class="labels">
                <span>0</span>
                <span>2k</span>
                <span>5k</span>
                <span>10k</span>
                <span>20k</span>
                <span>30k</span>
                <span>40k+</span>
            </div>
        </div>
        <div id="footer-links">
            <a href="#" id="footer-about-link" class="footer-link">ℹ️ About</a>
            <span class="footer-separator">•</span>
            <a href="https://buymeacoffee.com/anthonyhook" class="footer-link coffee-link" target="_blank" rel="noopener noreferrer">☕ Buy me a coffee</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Dynamically load config.js and app.js with correct path
        // This handles both /3d and /3d/ correctly
        (function() {
            // Get the current path and ensure it ends with /
            let scriptPath = window.location.pathname;
            if (!scriptPath.endsWith('/')) {
                scriptPath = scriptPath + '/';
            }

            function loadScript(src) {
                const script = document.createElement('script');
                script.src = scriptPath + src;
                document.body.appendChild(script);
            }

            loadScript('config.js');
            loadScript('app.js');
        })();
    </script>
</body>
</html>
