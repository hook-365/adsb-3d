<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>adsb-3d</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cookie&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <style>
        /* ========================================
           THEME VARIABLES - Unified Design System
           ======================================== */
        :root {
            /* Accent Colors */
            --accent-primary: #4a9eff;
            --accent-primary-dim: rgba(74, 158, 255, 0.3);
            --accent-primary-hover: rgba(74, 158, 255, 0.5);
            --accent-primary-active: rgba(74, 158, 255, 0.6);

            /* Panel Backgrounds */
            --panel-bg: rgba(0, 0, 0, 0.7);
            --panel-bg-solid: rgba(0, 0, 0, 0.85);
            --panel-border: rgba(74, 158, 255, 0.3);

            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --text-accent: #4a9eff;

            /* Panel Styling */
            --panel-padding: 15px;
            --panel-radius: 8px;
            --panel-blur: blur(10px);
            --panel-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            --panel-border-width: 1px;
            --panel-border-style: solid;

            /* Button Styling */
            --button-radius: 6px;
            --button-shadow: none;

            /* Input Styling */
            --input-radius: 4px;

            /* Badge Styling */
            --badge-radius: 4px;

            /* Typography */
            --font-weight-headers: 600;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-size-base: 12px;
            --font-size-large: 14px;
            --font-size-heading: 16px;
            --font-size-title: 18px;

            /* Spacing */
            --spacing-xs: 5px;
            --spacing-sm: 8px;
            --spacing-md: 10px;
            --spacing-lg: 15px;
            --spacing-xl: 20px;

            /* Z-Index Layers */
            --z-controls: 50;
            --z-panels: 100;
            --z-modals: 1000;

            /* ===== STATUS & STATE COLORS ===== */
            --status-success: #4eff9e;
            --status-success-bg: rgba(78, 255, 158, 0.1);
            --status-success-glow: rgba(78, 255, 158, 0.6);

            --status-error: #ff4a4a;
            --status-error-bg: rgba(255, 74, 74, 0.1);

            --status-warning: #ffaa4a;
            --status-warning-bg: rgba(255, 170, 74, 0.1);

            --status-offline: #888888;

            --mode-active: #00c853;
            --mode-active-border: #00e676;
            --mode-active-glow: rgba(0, 230, 118, 0.5);

            /* ===== BADGES & LABELS ===== */
            --badge-military: #cc0000;
            --badge-military-text: #ffffff;
            --badge-mlat: #d97634;
            --badge-mlat-text: #ffffff;
            --badge-stat: #1e5a8e;
            --badge-stat-text: #ffffff;

            /* ===== 3D SCENE ELEMENTS ===== */
            --military-color: #ff0000;
            --compass-north: #ff4444;
            --airport-label-bg: rgba(100, 100, 100, 0.7);
            --airport-label-text: #ffffff;
            --distance-ring-1: #888888;
            --distance-ring-2: #aaaaaa;
            --grid-center: #444444;
            --grid-lines: #2a2a2a;

            /* ===== SKY & LIGHTING ===== */
            --scene-fog: #87CEEB;
            --scene-ambient: #87CEEB;
            --scene-sun: #ffffee;
            --scene-ground: #5c7a3c;

            /* ===== RUNWAY & AIRPORT ===== */
            --runway-color: #ffffff;
            --tower-base: #eeeeee;
            --tower-light: #ff0000;
            --home-marker: #ffffff;

            /* ===== TRAIL & CURTAIN ===== */
            --trail-ground: #333333;
            --trail-selected: #ffffff;

            /* ===== MODAL & UI ===== */
            --modal-text-muted: #666666;
            --modal-text-strong: #cccccc;
            --modal-text-note: #888888;
            --bg-canvas: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-canvas);
            overflow: hidden;
            color: var(--text-primary);
        }

        /* ========================================
           UTILITY CLASSES - Consistent Styling System
           ======================================== */

        /* Panel Base - Apply to all panels for consistency */
        .panel-base {
            position: absolute;
            background: var(--panel-bg);
            padding: var(--panel-padding);
            border-radius: var(--panel-radius);
            backdrop-filter: var(--panel-blur);
            border: var(--panel-border-width) var(--panel-border-style) var(--panel-border);
            box-shadow: var(--panel-shadow);
            touch-action: auto;
            z-index: var(--z-panels);
        }

        .panel-solid {
            background: var(--panel-bg-solid);
        }

        /* Desktop Positioning */
        .pos-top-right {
            top: var(--spacing-xl);
            right: var(--spacing-xl);
        }

        .pos-top-left {
            top: var(--spacing-xl);
            left: var(--spacing-xl);
        }

        .pos-bottom-left {
            bottom: 100px;  /* Above footer */
            left: var(--spacing-xl);
        }

        /* Mobile Responsive Utilities */
        @media (max-width: 768px) {
            /* Mobile panel alignment - below mode selector */
            .mobile-panel-aligned {
                top: 50px !important;
                left: 10px !important;
                right: 10px !important;
                max-width: none !important;
                min-width: 0 !important;
                margin: 0 !important;
            }

            /* Mobile compact spacing */
            .mobile-compact-padding {
                padding: 8px !important;
            }

            .mobile-compact-gap {
                gap: 6px !important;
            }

            /* Mobile text sizing */
            .mobile-text-sm {
                font-size: 10px !important;
            }

            .mobile-text-md {
                font-size: 11px !important;
            }

            .mobile-text-lg {
                font-size: 12px !important;
            }
        }

        /* Spacing Utilities */
        .m-0 { margin: 0; }
        .m-sm { margin: var(--spacing-sm); }
        .m-md { margin: var(--spacing-md); }
        .p-0 { padding: 0; }
        .p-sm { padding: var(--spacing-sm); }
        .p-md { padding: var(--spacing-md); }
        .gap-xs { gap: var(--spacing-xs); }
        .gap-sm { gap: var(--spacing-sm); }
        .gap-md { gap: var(--spacing-md); }

        /* Text Utilities */
        .text-accent { color: var(--text-accent); }
        .text-secondary { color: var(--text-secondary); }
        .text-primary { color: var(--text-primary); }
        .text-xs { font-size: 11px; }
        .text-sm { font-size: var(--font-size-base); }
        .text-md { font-size: var(--font-size-large); }
        .text-lg { font-size: var(--font-size-heading); }
        .text-xl { font-size: var(--font-size-title); }

        /* Layout Utilities */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }

        /* Z-Index Utilities */
        .z-controls { z-index: var(--z-controls); }
        .z-panels { z-index: var(--z-panels); }
        .z-mode-selector { z-index: 110; }
        .z-modals { z-index: var(--z-modals); }

        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            touch-action: none; /* Prevent default touch behaviors on canvas */
        }

        /* ========================================
           PANEL BASE STYLES
           ======================================== */
        #info {
            position: absolute;
            top: var(--spacing-xl);
            left: var(--spacing-xl);
            background: var(--panel-bg);
            padding: var(--panel-padding) var(--spacing-xl);
            border-radius: var(--panel-radius);
            backdrop-filter: var(--panel-blur);
            border: 1px solid var(--panel-border);
            max-width: 300px;
            font-size: var(--font-size-large);
            line-height: 1.6;
            touch-action: auto;
            z-index: var(--z-panels);
        }

        #info h1 {
            font-size: var(--font-size-title);
            margin-bottom: var(--spacing-md);
            color: var(--text-accent);
        }

        .stat {
            display: flex;
            justify-content: space-between;
            margin: var(--spacing-xs) 0;
        }

        .stat .label {
            color: var(--text-secondary);
        }

        .stat .value {
            color: var(--text-primary);
            font-weight: bold;
        }

        /* Bottom Footer Bar */
        #footer-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--panel-bg-solid);
            backdrop-filter: var(--panel-blur);
            border-top: 1px solid var(--panel-border);
            padding: 8px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            z-index: 1000;
            font-size: 13px;
        }

        #footer-altitude {
            width: 100%;
            max-width: 500px;
            padding: 0 8px;
            box-sizing: border-box;
        }

        #footer-altitude .altitude-content {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        #footer-altitude .altitude-label {
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        #footer-altitude .gradient-bar {
            height: 16px;
            flex: 1;
            min-width: 0;
            border-radius: 8px;
            background: linear-gradient(to right,
                hsl(0, 0%, 45%) 0%,
                hsl(20, 88%, 44%) 5%,
                hsl(40, 88%, 44%) 10%,
                hsl(60, 88%, 44%) 15%,
                hsl(80, 88%, 44%) 20%,
                hsl(100, 88%, 44%) 25%,
                hsl(120, 88%, 44%) 30%,
                hsl(140, 88%, 44%) 35%,
                hsl(160, 88%, 44%) 45%,
                hsl(180, 88%, 44%) 55%,
                hsl(200, 88%, 44%) 65%,
                hsl(220, 88%, 44%) 75%,
                hsl(240, 88%, 44%) 80%,
                hsl(260, 88%, 44%) 85%,
                hsl(280, 88%, 44%) 90%,
                hsl(300, 88%, 44%) 95%,
                hsl(300, 88%, 44%) 100%
            );
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        #footer-altitude .labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--text-secondary);
            padding: 0 24px;
        }

        #footer-links {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 10px;
        }

        .footer-link {
            color: var(--text-accent);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid var(--accent-primary-dim);
            padding: 2px 8px;
            border-radius: 6px;
        }

        .footer-link:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Coffee link now same size as other footer links */

        .footer-separator {
            color: var(--text-secondary);
        }

        /* About Modal */
        #about-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            touch-action: auto;
        }

        #about-modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #about-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(74, 158, 255, 0.5);
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 600px;
            max-height: calc(100vh - 120px);  /* Account for footer and spacing */
            overflow-y: auto;
            backdrop-filter: blur(20px);
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -20px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* Keyboard Help Modal */
        /* Keyboard Help Sidebar (NEW) */
        #keyboard-help-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 350px;
            height: 100vh;
            background: var(--panel-bg-solid);
            border-right: 1px solid var(--panel-border);
            z-index: 9998;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #keyboard-help-sidebar.show {
            transform: translateX(0);
        }

        #keyboard-help-sidebar .header {
            padding: 15px;
            border-bottom: 1px solid var(--panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #keyboard-help-sidebar h2 {
            margin: 0;
            font-size: 18px;
            color: var(--text-accent);
        }

        #keyboard-help-sidebar .close-btn-help {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #keyboard-help-sidebar .close-btn-help:hover {
            color: var(--text-accent);
        }

        #keyboard-help-sidebar .content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        #keyboard-help-sidebar .shortcut-group {
            margin-bottom: 20px;
        }

        #keyboard-help-sidebar .shortcut-group-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-accent);
            text-transform: uppercase;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--panel-border);
        }

        #keyboard-help-sidebar .shortcut-item {
            display: grid;
            grid-template-columns: 50px 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }

        #keyboard-help-sidebar kbd {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 11px;
            white-space: nowrap;
            text-align: center;
            color: var(--text-accent);
        }

        #keyboard-help-sidebar .shortcut-desc {
            color: var(--text-secondary);
        }

        #keyboard-help-sidebar .mode-indicator {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Keyboard help overlay */
        #keyboard-help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9997;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #keyboard-help-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Legacy modal (kept for compat) */
        #keyboard-help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            touch-action: auto;
        }

        #keyboard-help-modal.show {
            display: flex;
        }

        #keyboard-help-modal .modal-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(74, 158, 255, 0.5);
            border-radius: 12px;
            padding: 30px 40px;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }

        #keyboard-help-modal h2 {
            color: var(--text-accent);
            margin: 0 0 20px 0;
            font-size: 24px;
        }

        #keyboard-help-modal kbd {
            background: var(--accent-primary-dim);
            border: 1px solid var(--accent-primary-hover);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: monospace;
            font-size: 14px;
            color: var(--text-accent);
            font-weight: bold;
        }

        /* Theme Modal Styles */
        #theme-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            touch-action: auto;
        }

        #theme-modal.show {
            display: flex;
        }

        #theme-modal h2 {
            color: var(--text-accent);
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .theme-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--panel-border);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .theme-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary-hover);
            transform: translateY(-2px);
        }

        .theme-card.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary-dim);
        }

        .theme-preview {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
            height: 40px;
        }

        .preview-color {
            flex: 1;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-card h3 {
            color: var(--text-primary);
            font-size: 14px;
            margin: 0 0 4px 0;
            font-weight: bold;
        }

        .theme-card p {
            color: var(--text-secondary);
            font-size: 11px;
            margin: 0;
        }

        .theme-active-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--status-success);
            color: #000;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
        }

        .theme-card.active .theme-active-indicator {
            display: block;
        }

        #about-content h2 {
            color: var(--text-accent);
            margin: 0 0 20px 0;
            font-size: 28px;
            border-bottom: 2px solid var(--panel-border);
            padding-bottom: 10px;
        }

        #about-content h3 {
            color: var(--text-accent);
            font-size: 16px;
            margin: 20px 0 10px 0;
        }

        #about-content p {
            color: var(--modal-text-strong);
            line-height: 1.8;
            margin: 15px 0;
            font-size: 14px;
        }

        #about-content .version {
            color: var(--text-accent);
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
        }

        #about-content .author {
            color: var(--text-secondary);
            font-size: 13px;
            margin: 10px 0;
        }

        #about-content a {
            color: var(--text-accent);
            text-decoration: none;
        }

        #about-content a:hover {
            color: var(--accent-primary);
        }

        #about-content strong {
            color: var(--modal-text-strong);
        }

        #about-content .note {
            font-size: 10px;
            color: var(--modal-text-muted);
            font-style: italic;
        }

        #about-content .data-source {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 10px;
        }

        /* Utility classes for labels and text */
        .section-label {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-accent);
            font-size: 13px;
        }

        .label-bold {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-accent);
        }

        .text-muted-sm {
            font-size: 11px;
            color: var(--modal-text-note);
        }

        .help-text {
            font-size: 11px;
            color: var(--modal-text-note);
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .playback-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .playback-btn {
            flex: 0 0 auto;
            padding: 8px 16px;
            font-size: 12px;
        }

        .playback-btn-small {
            flex: 0 0 auto;
            padding: 8px 12px;
            font-size: 12px;
        }

        .playback-speed-select {
            flex: 1 1 auto;
            min-width: 100px;
            max-width: 150px;
        }

        .timeline-times {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--modal-text-note);
            margin-bottom: 8px;
        }

        .playback-status {
            font-size: 11px;
            color: var(--modal-text-note);
            text-align: center;
        }

        .action-btn {
            grid-column: 1 / -1;
            background: var(--accent-primary-dim);
            color: var(--text-primary);
            border: 1px solid var(--accent-primary-hover);
            padding: var(--spacing-sm);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--accent-primary);
        }

        .secondary-btn {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: var(--spacing-sm);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .full-width-btn {
            margin-top: 15px;
            padding: 8px 16px;
            background: var(--accent-primary);
            border: 1px solid var(--accent-primary-hover);
            color: var(--button-text);
            cursor: pointer;
            border-radius: 4px;
            width: 100%;
        }

        .full-width-btn:hover {
            background: var(--accent-primary-hover);
        }

        .timeline-scrubber {
            width: 100%;
            cursor: pointer;
        }

        #about-content .github-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--accent-primary-dim);
            border: 1px solid var(--accent-primary-hover);
            border-radius: 6px;
            color: var(--text-accent);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        #about-content .github-link:hover {
            background: var(--accent-primary-hover);
            border-color: var(--accent-primary-active);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--accent-primary-hover);
        }

        #about-content .github-link.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        #about-content .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            transition: all 0.2s ease;
        }

        #about-content .close-btn:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        #about-content .feature-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        #about-content .feature-list li {
            padding: 5px 0 5px 20px;
            position: relative;
            color: var(--modal-text-strong);
            font-size: 13px;
        }

        #about-content .feature-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: var(--text-accent);
            font-weight: bold;
        }


        #controls {
            position: absolute;
            bottom: 100px;  /* Higher to clear footer with altitude chart */
            left: 30px;    /* Mirror coffee button position */
            background: var(--panel-bg);
            padding: var(--panel-padding);
            border-radius: var(--panel-radius);
            backdrop-filter: var(--panel-blur);
            border: 1px solid var(--panel-border);
            font-size: var(--font-size-base);
            max-width: 300px;
            touch-action: auto;
            z-index: var(--z-panels);
        }

        #controls button {
            background: var(--accent-primary-dim);
            color: var(--text-primary);
            border: 1px solid var(--accent-primary-hover);
            padding: var(--spacing-sm) 16px;
            margin: 0 var(--spacing-xs);
            border-radius: var(--panel-radius);
            cursor: pointer;
            font-size: var(--font-size-base);
            transition: all 0.3s ease;
            backdrop-filter: var(--panel-blur);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #controls button:hover {
            background: var(--accent-primary-hover);
            border-color: var(--accent-primary-active);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--accent-primary-dim);
        }

        #controls button.active {
            background: var(--accent-primary-active);
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px var(--accent-primary-hover);
        }


        /* Mode transition effects */
        .mode-transition {
            transition: opacity 0.3s ease-in-out;
        }

        .mode-transition.fading {
            opacity: 0.3;
        }

        /* Status indicator */
        .api-status {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.85);
            padding: 6px 12px;
            border-radius: 14px;
            z-index: 100;
            border: 1px solid var(--accent-primary-dim);
        }

        .api-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-success);
            box-shadow: 0 0 8px var(--status-success-glow);
        }

        .api-status-dot.offline {
            background: var(--status-offline);
            box-shadow: none;
        }

        /* Small inline status dot for info panel */
        .api-status-dot-small {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--status-success);
            box-shadow: 0 0 6px var(--status-success-glow);
            margin-right: 6px;
            vertical-align: middle;
        }

        .api-status-dot-small.offline {
            background: var(--status-offline);
            box-shadow: none;
        }

        #api-status-inline {
            display: flex;
            align-items: center;
        }

        /* Custom Calendar Picker */
        .calendar-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--accent-primary-dim);
            border-radius: 12px;
            padding: 16px;
            z-index: 10001;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            min-width: 280px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            color: var(--text-primary);
            font-weight: bold;
        }

        .calendar-nav {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav:hover {
            background: var(--accent-primary-dim);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: var(--accent-primary-dim);
        }

        .calendar-day.other-month {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .calendar-day.selected {
            background: var(--accent-primary);
            color: #fff;
            font-weight: bold;
        }

        .calendar-day.today {
            border-color: var(--accent-primary);
        }

        .calendar-time {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 12px;
        }

        .calendar-time-input {
            width: 50px;
            padding: 6px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .calendar-time-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .calendar-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }

        .calendar-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
        }

        .calendar-btn:hover {
            background: var(--bg-secondary);
        }

        .calendar-btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .calendar-btn-primary:hover {
            background: var(--accent-hover);
        }

        .calendar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }

        .calendar-input {
            cursor: pointer !important;
            font-size: 12px !important;
            padding: 10px 12px !important;
            background: var(--bg-tertiary) !important;
            border: 1px dashed var(--accent-primary-dim) !important;
            border-radius: 6px !important;
            color: var(--text-primary) !important;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        .calendar-input:hover {
            border-color: var(--accent-primary) !important;
            border-style: solid !important;
            background: var(--bg-secondary) !important;
            box-shadow: 0 0 8px rgba(68, 138, 255, 0.3);
        }

        .calendar-input:focus {
            outline: none;
            border-color: var(--accent-primary) !important;
            border-style: solid !important;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: var(--text-accent);
        }

        #aircraft-detail {
            position: absolute;
            bottom: 170px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            min-width: 380px;
            max-width: 450px;
            display: none;
            border: 2px solid var(--accent-primary);
            touch-action: auto; /* Allow normal touch on UI panels */
            overflow: hidden; /* Contain scrolling to body */
            z-index: 2000; /* Ensure it's above other UI elements */
        }

        #aircraft-detail .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.95);
            border-bottom: 1px solid rgba(74, 158, 255, 0.3);
            flex-shrink: 0; /* Don't shrink when body scrolls */
        }

        #aircraft-detail h3 {
            color: var(--text-accent);
            margin: 0;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            padding-right: 10px;
        }

        #aircraft-detail .detail-body {
            padding: 0;  /* Content will handle its own padding */
            overflow-y: auto;
            overflow-x: hidden; /* Prevent horizontal scroll */
            max-height: 60vh; /* Limit height for scrolling */
            /* Custom scrollbar styling for visibility */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: rgba(74, 158, 255, 0.5) rgba(255, 255, 255, 0.1); /* Firefox */
        }

        /* Force scrollbar to always be visible when content is scrollable */
        #aircraft-detail .detail-body.scrollable {
            overflow-y: scroll; /* Always show scrollbar when scrollable */
        }

        /* Webkit browsers (Chrome, Safari, Edge) scrollbar styling */
        #aircraft-detail .detail-body::-webkit-scrollbar {
            width: 8px;
            background: rgba(0, 0, 0, 0.3);
        }

        #aircraft-detail .detail-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 4px 0;
        }

        #aircraft-detail .detail-body::-webkit-scrollbar-thumb {
            background: rgba(74, 158, 255, 0.6);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #aircraft-detail .detail-body::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 158, 255, 0.8);
        }

        #aircraft-detail .detail-body::-webkit-scrollbar-thumb:active {
            background: rgba(74, 158, 255, 1);
        }

        /* Visual indicator that content is scrollable */
        #aircraft-detail .detail-body {
            position: relative;
        }

        /* Add subtle shadow at bottom when scrollable */
        #aircraft-detail .detail-body::after {
            content: '';
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #aircraft-detail .detail-body.scrollable::after {
            opacity: 1;
        }

        /* Section styles for organized display */
        #aircraft-detail .section-header {
            color: var(--text-accent);
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            padding-bottom: 3px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #aircraft-detail .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 20px;
            font-size: 12px;
            line-height: 1.5;
        }

        #aircraft-detail .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #aircraft-detail .detail-label {
            color: var(--text-secondary);
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #aircraft-detail .detail-value {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 12px;
            word-break: break-word;
        }

        /* Compact signal status bar */
        #aircraft-detail .signal-bar {
            display: flex;
            gap: 12px;
            padding: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            font-size: 10px;
            margin-bottom: 8px;
        }

        #aircraft-detail .signal-item {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        #aircraft-detail .close-btn {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            flex-shrink: 0;
        }

        #aircraft-detail .close-btn:hover {
            color: var(--text-accent);
        }

        #aircraft-detail .detail-footer {
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.95);
            border-top: 1px solid rgba(74, 158, 255, 0.3);
            flex-shrink: 0;
        }

        #aircraft-detail .detail-footer .full-width-btn {
            width: 100%;
            padding: 10px 16px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        #aircraft-detail .detail-footer .full-width-btn:hover {
            background: var(--accent-secondary);
        }

        #unfollow-btn {
            display: none;
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(255, 68, 68, 1);
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        #unfollow-btn:hover {
            background: rgba(255, 40, 40, 1);
            border-color: rgba(255, 20, 20, 1);
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.5);
        }

        #altitude-chart {
            display: none; /* Hidden - now in footer */
        }

        #altitude-chart .chart-title {
            color: var(--text-accent);
            font-size: 11px;  /* Smaller title */
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;  /* Small gap below title */
        }

        #altitude-chart .gradient-bar {
            height: 20px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(to right,
                hsl(0, 0%, 45%) 0%,
                hsl(20, 88%, 44%) 5%,
                hsl(40, 88%, 44%) 10%,
                hsl(60, 88%, 44%) 15%,
                hsl(80, 88%, 44%) 20%,
                hsl(100, 88%, 44%) 25%,
                hsl(120, 88%, 44%) 30%,
                hsl(140, 88%, 44%) 35%,
                hsl(160, 88%, 44%) 45%,
                hsl(180, 88%, 44%) 55%,
                hsl(200, 88%, 44%) 65%,
                hsl(220, 88%, 44%) 75%,
                hsl(240, 88%, 44%) 80%,
                hsl(260, 88%, 44%) 85%,
                hsl(280, 88%, 44%) 90%,
                hsl(300, 88%, 44%) 95%,
                hsl(300, 88%, 44%) 100%
            );
        }

        #altitude-chart .labels {
            display: flex;
            justify-content: space-between;
            color: var(--modal-text-strong);
            font-size: 10px;
            padding: 0 2px;
        }

        #altitude-chart .label-marker {
            position: relative;
            text-align: center;
        }

        /* Enhanced aircraft list item hover */
        .aircraft-item {
            transition: all 0.3s ease;
        }

        /* Floating North Arrow on 3D Canvas */
        #north-arrow {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent-primary-dim);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 100;
            transition: transform 0.1s ease-out;
        }

        #north-arrow .arrow-icon {
            font-size: 24px;
            color: var(--compass-north);
            line-height: 1;
            margin-bottom: -2px;
        }

        #north-arrow .arrow-label {
            font-size: 11px;
            color: var(--compass-north);
            line-height: 1;
        }


        /* Keyboard shortcut hint */
        .keyboard-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
            font-size: 10px;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .keyboard-hint.show {
            opacity: 1;
        }

        .keyboard-hint kbd {
            background: var(--accent-primary-dim);
            border: 1px solid var(--accent-primary-hover);
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            color: var(--text-accent);
            margin: 0 2px;
        }

        /* Collapseable Panel Styles */
        .collapseable-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .collapseable-panel .panel-header h1,
        .collapseable-panel .panel-header h2,
        .collapseable-panel .panel-header h4 {
            margin: 0;
            flex-grow: 1;
            font-weight: var(--font-weight-headers);
        }

        .collapseable-panel .panel-header .controls-title {
            color: var(--text-accent);
            font-size: var(--font-size-large);
            font-weight: bold;
            letter-spacing: 0.5px;
            white-space: nowrap;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .collapse-btn {
            background: var(--accent-primary-dim);
            border: var(--panel-border-width) solid var(--accent-primary-hover);  /* Match theme border width */
            color: var(--text-accent);
            width: 24px;
            height: 24px;
            border-radius: var(--button-radius);  /* Respect theme styling */
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-left: 10px;
            margin-right: 0;
        }

        .collapse-btn:hover {
            background: var(--accent-primary-hover);
            border-color: var(--accent-primary-active);
        }

        .collapseable-panel.collapsed .panel-content {
            display: none !important;
        }

        .collapseable-panel.collapsed .collapse-btn {
            transform: rotate(180deg);
        }

        /* Panel header as button (like mode buttons) */
        .panel-header-btn {
            width: 100%;
            background: transparent;
            color: var(--text-primary);
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .panel-header-btn:hover {
            background: rgba(74, 158, 255, 0.15);
        }

        .panel-header-btn .collapse-indicator {
            font-size: 16px;
            transition: transform 0.3s ease;
            margin-left: 8px;
            margin-right: 4px;  /* Add breathing room on the right */
            color: var(--text-accent);
        }

        .collapseable-panel.collapsed .panel-header-btn .collapse-indicator {
            transform: rotate(180deg);
        }

        .collapseable-panel.collapsed .panel-header {
            margin-bottom: 0;
        }

        /* Ensure controls panel collapses properly */
        #controls.collapseable-panel.collapsed .panel-content {
            display: none !important;
        }

        /* Adjust info panel header for flex layout */
        #info .panel-header h1 {
            font-size: 18px;
            color: var(--text-accent);
        }

        /* Controls panel header matches aircraft-list */
        #controls .panel-header h2 {
            font-size: 16px;
            color: var(--text-accent);
        }


        /* Adjust controls panel for collapseable */
        #controls.collapseable-panel {
            padding: 0;  /* No outer padding - let panel-header handle spacing */
        }

        #controls.collapseable-panel .panel-header {
            padding: 10px 15px;  /* Panel header has padding */
            margin-bottom: 0;
        }

        #controls.collapseable-panel .panel-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-md);
            padding: 0 15px 10px 15px;  /* Content padding (no top since header has bottom) */
            max-height: 400px;  /* Maximum height before scrolling */
            overflow-y: auto;  /* Enable vertical scrolling */
            overflow-x: hidden;  /* No horizontal scroll */
        }

        /* Custom scrollbar styling for settings */
        #controls.collapseable-panel .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        #controls.collapseable-panel .panel-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        #controls.collapseable-panel .panel-content::-webkit-scrollbar-thumb {
            background: var(--accent-primary-dim);
            border-radius: 3px;
        }

        #controls.collapseable-panel .panel-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary-hover);
        }

        /* ========================================
           UNIFIED SIDEBAR STYLES
           ======================================== */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 60px; /* Account for footer bar height */
            width: 320px;
            height: calc(100vh - 60px); /* Subtract footer height */
            background: var(--panel-bg);
            backdrop-filter: var(--panel-blur);
            border-left: var(--panel-border-width) solid var(--panel-border);
            display: flex;
            flex-direction: column;
            z-index: var(--z-panels);
            transition: transform 0.3s ease, width 0.1s ease;
        }

        .sidebar.collapsed {
            transform: translateX(100%);
        }

        /* Resize Handle */
        .sidebar-resize-handle {
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: transparent;
            cursor: ew-resize;
            transition: background 0.2s ease;
            z-index: 10;
        }

        .sidebar-resize-handle:hover {
            background: var(--accent-primary-hover);
        }

        .sidebar-resize-handle:active {
            background: var(--accent-primary);
        }

        /* Toggle Button */
        .sidebar-toggle-btn {
            position: absolute;
            left: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 80px;
            background: var(--panel-bg);
            backdrop-filter: var(--panel-blur);
            border: var(--panel-border-width) solid var(--panel-border);
            border-right: none;
            border-radius: var(--panel-radius) 0 0 var(--panel-radius);
            color: var(--text-accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .sidebar-toggle-btn:hover {
            background: var(--accent-primary-dim);
        }

        /* Lock/Pin Button */
        .sidebar-lock-btn {
            position: absolute;
            left: -40px;
            bottom: 80px; /* Above the footer area */
            width: 40px;
            height: 40px;
            background: var(--panel-bg);
            backdrop-filter: var(--panel-blur);
            border: var(--panel-border-width) solid var(--panel-border);
            border-right: none;
            border-radius: var(--panel-radius) 0 0 var(--panel-radius);
            color: var(--text-accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
            z-index: 10002;
            pointer-events: auto;
        }

        .sidebar-lock-btn:hover {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
        }

        .sidebar-lock-btn.locked {
            background: var(--accent-primary-dim);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .sidebar-lock-btn .lock-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
        }

        /* When sidebar is locked, adjust canvas to use left side only */
        body.sidebar-locked canvas {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
        }

        /* Hide collapse button when locked */
        body.sidebar-locked .sidebar-toggle-btn {
            display: none !important;
        }

        /* Ensure sidebar stays visible when locked */
        body.sidebar-locked .sidebar {
            transform: translateX(0) !important;
        }

        /* No rotation needed - using directional symbols */

        /* Sidebar Content */
        .sidebar-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            padding: var(--spacing-lg);
        }

        /* Mode Header */
        /* Mode Tabs */
        .sidebar-mode-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: var(--spacing-lg);
        }

        .sidebar-mode-tab {
            flex: 1;
            background: var(--panel-bg);
            color: var(--text-secondary);
            border: 1px solid var(--panel-border);
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: var(--font-size-base);
            border-radius: var(--panel-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .sidebar-mode-tab:hover {
            background: var(--panel-bg-solid);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .sidebar-mode-tab.active {
            background: var(--accent-primary-dim);
            color: var(--text-accent);
            border-color: var(--accent-primary);
            box-shadow: 0 4px 8px rgba(74, 158, 255, 0.3);
        }

        .sidebar-mode-tab.active:hover {
            transform: none;
        }

        /* Mode Content Sections */
        .sidebar-mode-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        /* Stats */
        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-base);
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--text-accent);
            font-weight: bold;
        }

        /* Dividers */
        .sidebar-divider {
            height: 1px;
            background: var(--panel-border);
            margin: var(--spacing-sm) 0;
        }

        /* Section Labels */
        .sidebar-section-label {
            color: var(--text-accent);
            font-size: var(--font-size-base);
            font-weight: bold;
            margin-bottom: var(--spacing-sm);
        }

        /* Search */
        .sidebar-search {
            position: relative;
            margin-bottom: var(--spacing-md);
        }

        .sidebar-search input {
            width: 100%;
            padding: 8px 30px 8px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--panel-border);
            border-radius: var(--input-radius);
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }

        .sidebar-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .sidebar-search .search-clear-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .sidebar-search input:not(:placeholder-shown) + .search-clear-btn {
            opacity: 1;
        }

        .sidebar-search .search-clear-btn:hover {
            color: var(--text-accent);
        }

        /* Badge Legend */
        .sidebar-badge-legend {
            display: flex;
            gap: 8px;
            padding: 6px 8px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--panel-border);
            border-radius: var(--input-radius);
            font-size: 10px;
            color: var(--text-secondary);
        }

        .legend-item {
            flex: 1;
            text-align: center;
            white-space: nowrap;
            line-height: 1.2;
        }

        /* Aircraft List */
        .sidebar-aircraft-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            margin: -8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--button-radius);
        }

        .sidebar-aircraft-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: var(--button-radius);
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow:
                0 2px 6px rgba(0, 0, 0, 0.3),
                0 0 8px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            margin-left: 0;
        }

        .sidebar-aircraft-item:hover,
        .sidebar-aircraft-item.highlighted {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.4),
                0 0 16px var(--accent-primary-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateX(-3px);
            margin-left: 3px;
        }

        .sidebar-aircraft-item.selected {
            background: var(--accent-primary-dim);
            border-color: var(--accent-primary);
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.5),
                0 0 20px var(--accent-primary-glow),
                0 0 40px var(--accent-primary-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Aircraft item content styling - NO font-weight changes to prevent flicker */
        .aircraft-item-content {
            opacity: 1;
        }

        .aircraft-item-content.stale {
            opacity: 0.6;
        }

        .aircraft-callsign {
            color: var(--text-accent);
        }

        .aircraft-callsign.stale {
            color: #999;
        }

        .aircraft-altitude {
            color: var(--text-primary);
        }

        .aircraft-altitude.stale {
            color: var(--text-secondary);
        }

        /* Sidebar Sections */
        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .sidebar-section label {
            color: var(--text-secondary);
            font-size: var(--font-size-base);
        }

        /* Inputs */
        .sidebar-input,
        .sidebar-select {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--panel-border);
            border-radius: var(--input-radius);
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }

        .sidebar-input:focus,
        .sidebar-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        /* Button Groups */
        .sidebar-button-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .sidebar-button {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--panel-border);
            border-radius: var(--button-radius);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-size-base);
            text-align: center;
        }

        .sidebar-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        .sidebar-button.sidebar-button-primary {
            background: var(--accent-primary-dim);
            border-color: var(--accent-primary);
            color: var(--text-accent);
        }

        .sidebar-button.sidebar-button-primary:hover {
            background: var(--accent-primary);
            box-shadow: 0 0 12px var(--accent-primary-glow);
        }

        .sidebar-button.sidebar-button-active {
            background: var(--accent-primary-dim);
            border-color: var(--accent-primary);
            color: var(--text-accent);
        }

        .sidebar-button.sidebar-button-small {
            padding: 4px 8px;
            font-size: 10px;
        }

        /* Timeline/Range Inputs */
        .sidebar-range {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }

        .sidebar-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .sidebar-range::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Search Input */
        .sidebar-search-input {
            width: 100%;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--panel-border);
            border-radius: var(--input-radius);
            color: var(--text-primary);
            font-size: var(--font-size-small);
        }

        .sidebar-search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        /* Info Text */
        .sidebar-info {
            font-size: var(--font-size-small);
            color: var(--text-secondary);
            text-align: center;
            padding: 4px;
        }

        /* Radio Groups */
        .sidebar-radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px;
            border-radius: var(--button-radius);
            transition: background 0.2s ease;
        }

        .sidebar-radio-label:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar-radio-label input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        /* Buttons */
        .sidebar-button {
            width: 100%;
            padding: 10px;
            background: var(--accent-primary-dim);
            border: 1px solid var(--accent-primary);
            border-radius: var(--button-radius);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-button:hover {
            background: var(--accent-primary-hover);
        }

        .sidebar-button-primary {
            background: var(--accent-primary);
            font-weight: bold;
        }

        .sidebar-button-primary:hover {
            background: var(--accent-primary-hover);
            transform: translateY(-1px);
        }

        /* Info text */
        .sidebar-info {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            text-align: center;
            padding: 8px;
        }

        /* Footer */
        .sidebar-footer {
            border-top: 1px solid var(--panel-border);
            padding-top: var(--spacing-md);
            margin-top: auto;
        }

        .sidebar-footer-toggle {
            width: 100%;
            padding: 8px;
            background: var(--accent-primary-dim);
            border: 1px solid var(--panel-border);
            border-radius: var(--button-radius);
            color: var(--text-accent);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: var(--spacing-sm);
        }

        .sidebar-footer-toggle:hover {
            background: var(--accent-primary-hover);
        }

        .sidebar-footer-content {
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sidebar-footer-content.collapsed {
            max-height: 0;
        }

        /* Historical Filters */
        .historical-input-group {
            margin-bottom: var(--spacing-sm);
        }

        .historical-input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: var(--font-size-small);
            margin-bottom: 4px;
        }

        .historical-input {
            width: 100%;
            padding: 6px 8px;
            background: var(--panel-bg-secondary);
            border: 1px solid var(--panel-border);
            border-radius: var(--input-radius);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            transition: all 0.2s ease;
        }

        .historical-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--panel-bg);
        }

        .historical-load-btn {
            width: 100%;
            padding: 8px 12px;
            background: var(--accent-primary);
            border: none;
            border-radius: var(--button-radius);
            color: var(--text-contrast);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .historical-load-btn:hover {
            background: var(--accent-primary-hover);
            transform: translateY(-1px);
        }

        .historical-load-btn:active {
            transform: translateY(0);
        }

        .nested-collapse-btn {
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s ease;
        }

        /* Scrollbar Styling */
        /* Scrollbar - overlay style, only visible when scrolling */
        .sidebar-mode-content,
        .sidebar-aircraft-list {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary-dim) transparent;
        }

        .sidebar-mode-content::-webkit-scrollbar,
        .sidebar-aircraft-list::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar-mode-content::-webkit-scrollbar-track,
        .sidebar-aircraft-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-mode-content::-webkit-scrollbar-thumb,
        .sidebar-aircraft-list::-webkit-scrollbar-thumb {
            background: var(--accent-primary-dim);
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .sidebar-mode-content::-webkit-scrollbar-thumb:hover,
        .sidebar-aircraft-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary-hover);
            background-clip: padding-box;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }

            .sidebar-mode-header {
                font-size: var(--font-size-base);
                padding: 10px;
            }

            /* ===== SIDEBAR CORE ===== */
            .sidebar-content {
                padding: var(--spacing-sm);  /* 8px instead of 10px */
            }

            /* ===== MODE TABS ===== */
            .sidebar-mode-tabs {
                gap: 6px;
                margin-bottom: var(--spacing-sm);
            }

            .sidebar-mode-tab {
                padding: 6px 10px;
                font-size: 11px;
            }

            /* ===== SECTIONS & SPACING ===== */
            .sidebar-section {
                gap: 5px;
            }

            .sidebar-section-label {
                font-size: 11px;
                margin-bottom: 5px;
            }

            .sidebar-divider {
                margin: 5px 0;
            }

            /* ===== STATS ===== */
            .sidebar-stats {
                gap: 5px;
                margin-bottom: var(--spacing-sm);
            }

            .stat-item {
                font-size: 11px;
            }

            .stat-label {
                font-size: 10px;
            }

            /* ===== SEARCH ===== */
            .sidebar-search {
                margin-bottom: var(--spacing-sm);
            }

            .sidebar-search input {
                padding: 6px 28px 6px 8px;
                font-size: 11px;
            }

            /* ===== BADGE LEGEND ===== */
            .sidebar-badge-legend {
                padding: 4px 6px;
                margin: 6px 0;
                font-size: 9px;
                gap: 6px;
            }

            /* ===== AIRCRAFT LIST ===== */
            .sidebar-aircraft-item {
                padding: 6px;
                margin-bottom: 4px;
                font-size: 11px;
            }

            .sidebar-aircraft-item:hover,
            .sidebar-aircraft-item.highlighted {
                transform: none;
                margin-left: 0;
            }

            /* ===== INPUTS & SELECTS ===== */
            .sidebar-input,
            .sidebar-select {
                padding: 6px;
                font-size: 11px;
            }

            .sidebar-select[type="datetime-local"] {
                font-size: 10px;
                padding: 5px;
            }

            /* ===== BUTTONS ===== */
            .sidebar-button {
                padding: 6px 8px;
                font-size: 11px;
            }

            .sidebar-button-small {
                padding: 3px 5px;
                font-size: 9px;
            }

            .sidebar-button-primary {
                padding: 7px 10px;
            }

            /* ===== BUTTON GROUPS ===== */
            .sidebar-button-group {
                gap: 6px;
            }

            /* ===== RADIO BUTTONS ===== */
            .sidebar-radio-label {
                padding: 4px 6px;
                font-size: 10px;
            }

            /* ===== RANGE SLIDER ===== */
            .sidebar-range::-webkit-slider-thumb {
                width: 12px;
                height: 12px;
            }

            .sidebar-range::-moz-range-thumb {
                width: 12px;
                height: 12px;
            }

            /* ===== INFO TEXT ===== */
            .sidebar-info {
                padding: 5px;
                font-size: 11px;
            }

            /* ===== PLAYBACK CONTROLS ===== */
            .sidebar-playback-speed,
            .sidebar-skip-controls,
            .sidebar-timeline {
                margin-top: 6px !important;
            }

            .sidebar-timeline-info {
                margin-top: 2px !important;
                font-size: 9px !important;
            }

            #sidebar-playback-speed {
                width: 80px !important;
                font-size: 10px;
            }

            /* ===== TRACK FILTERS ===== */
            .sidebar-track-filters > div {
                gap: 6px !important;
                margin-top: 5px !important;
            }

            .sidebar-track-filters label {
                font-size: 10px;
            }

            #sidebar-track-count {
                font-size: 10px !important;
            }

            /* ===== TOGGLE SWITCHES ===== */
            .toggle-switch {
                width: 34px;
                height: 16px;
            }

            .toggle-switch::after {
                width: 12px;
                height: 12px;
            }

            .toggle-switch-container {
                padding: 5px;
            }

            .toggle-switch-label {
                font-size: 10px;
            }

            /* ===== SCROLLBAR ===== */
            .sidebar-mode-content::-webkit-scrollbar,
            .sidebar-aircraft-list::-webkit-scrollbar {
                width: 6px;
            }

            /* ===== HISTORICAL FILTERS ===== */
            .historical-input-group {
                margin-bottom: 6px;
            }

            .historical-input-group label {
                font-size: 10px;
            }

            .historical-input {
                padding: 5px 6px;
                font-size: 11px;
            }

            .historical-load-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            /* ===== FOOTER (if enabled) ===== */
            .sidebar-footer {
                padding-top: var(--spacing-sm);
            }

            .sidebar-footer-toggle {
                padding: 6px;
                font-size: 11px;
            }
        }

        /* Extra small phones */
        @media (max-width: 480px) {
            .sidebar {
                width: 100%;
                max-width: 300px;  /* Reduced from 320px */
            }
        }

        @media (max-width: 360px) {
            .sidebar {
                max-width: 280px;
            }
        }


        /* Toggle Switch Styles */
        .toggle-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch-container:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .toggle-switch-label {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            user-select: none;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch-container.active .toggle-switch {
            background: var(--accent-primary);
        }

        .toggle-switch-container.active .toggle-switch::after {
            transform: translateX(20px);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Compact footer on mobile */
            #footer-bar {
                padding: 6px 10px;
                font-size: 11px;
                gap: 4px;
            }

            #footer-altitude {
                max-width: 100%;
                padding: 0 4px;
            }

            #footer-altitude .altitude-label {
                font-size: 9px;
            }

            #footer-altitude .gradient-bar {
                height: 14px;
            }

            #footer-altitude .labels {
                font-size: 8px;
                padding: 0 20px;
            }

            #footer-links {
                font-size: 10px;
            }

            /* Hide standalone altitude chart on mobile */
            #altitude-chart {
                display: none !important;
            }

            /* Info panel on mobile - align to right like historical controls */
            #info {
                top: 50px !important;  /* Below mode selector buttons */
                right: 10px !important;  /* Align to right edge */
                left: auto !important;  /* Don't set left - let it size naturally */
                max-width: 200px !important;  /* Compact width on mobile */
                min-width: 0 !important;
                font-size: 12px;
                padding: 8px !important;
                margin: 0 !important;
                border: 1px solid var(--panel-border) !important;
            }

            #info h1 {
                font-size: 14px;
            }

            /* When expanded on mobile, allow wider */
            #info:not(.collapsed):not(.mobile-collapsed) {
                max-width: calc(100vw - 20px);
            }

            #aircraft-list {
                /* Override utility class - align to RIGHT only, not full width */
                top: 50px !important;
                right: 10px !important;
                left: auto !important;  /* Don't span full width */
                max-width: calc(100vw - 20px) !important;  /* Allow expanding but not full width */
                min-width: 200px !important;  /* Minimum compact size */
                max-height: calc(60vh - 80px);  /* More room with footer-integrated altitude */
                font-size: 11px;
                padding: 8px !important;
                margin: 0 !important;
                z-index: 100;  /* Ensure visible */
                /* display controlled by JavaScript mode switching - don't override */
            }

            #controls {
                top: auto;
                left: 10px;
                right: auto;  /* Don't stretch full width */
                bottom: 100px;  /* Above footer */
                transform: none;
                max-width: none;  /* Allow to expand properly */
                width: auto;  /* Auto width */
                padding: 0;  /* No outer padding */
                pointer-events: auto;
                z-index: 105;  /* Higher than other elements */
            }

            #controls .panel-header-btn {
                margin: 0;
                padding-right: 6px;
            }

            /* When collapsed, constrain width */
            #controls.collapsed,
            #controls.mobile-collapsed {
                max-width: 120px;
            }

            /* Ensure collapsed controls don't block canvas */
            #controls.collapsed {
                pointer-events: none;
            }

            #controls.collapsed .panel-header,
            #controls.collapsed .panel-header-btn {
                pointer-events: auto;
            }

            /* Match mode button styling exactly */
            #controls.collapseable-panel .panel-header {
                padding: 6px 8px;  /* Panel header padding for mobile - reduced right padding */
                margin: 0;
                min-width: 0;  /* Allow flex to compress properly */
            }

            #controls.collapseable-panel .panel-header .controls-title {
                min-width: 0;  /* Allow title to compress on mobile */
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #controls.collapseable-panel .collapse-btn {
                margin-left: 8px;  /* Reduced from 10px for mobile space */
                margin-right: 0;
                flex-shrink: 0;
            }

            #controls.collapseable-panel .panel-content {
                padding: 0 10px 6px 10px;  /* Content padding for mobile */
                max-height: 250px;  /* Smaller max height on mobile */
            }

            #controls button {
                padding: 12px 8px;  /* Increased for 44px minimum touch target */
                font-size: 11px;    /* Slightly larger for readability */
                margin: 2px 2px;
                min-height: 44px;   /* Ensure minimum touch target */
            }

            /* Collapse panels by default on mobile */
            .collapseable-panel.mobile-collapsed .panel-content {
                display: none !important;
            }

            .collapseable-panel.mobile-collapsed .collapse-btn {
                transform: rotate(180deg);
            }

            /* Make detail panel full width on mobile */
            #aircraft-detail {
                max-width: calc(100vw - 40px);
                min-width: calc(100vw - 40px);
                width: auto;
                left: 20px;
                right: 20px;
                top: 60px;  /* Position below header area */
                bottom: auto;
                transform: none; /* Remove centering transform */
                max-height: 70vh; /* Reduced height to fit on screen */
                flex-direction: column;
                /* Note: display is controlled by JS - don't override display:none here */
            }

            /* When shown, use flexbox layout */
            #aircraft-detail[style*="display: block"],
            #aircraft-detail[style*="display:block"] {
                display: flex !important;
            }

            #aircraft-detail .detail-header {
                padding: 8px 12px;
                background: linear-gradient(135deg, rgba(0, 0, 0, 0.98), rgba(10, 20, 30, 0.95));
                border-bottom: 1px solid var(--accent-primary);
                flex-shrink: 0;
            }

            #aircraft-detail h3 {
                font-size: 13px;
                font-weight: 600;
                color: var(--text-primary);
            }

            #aircraft-detail .detail-body {
                padding: 8px 12px;
                flex: 1;
                min-height: 0; /* Allow flex shrinking */
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }

            #aircraft-detail .detail-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;  /* Two equal columns for mobile */
                gap: 6px 10px;
                font-size: 11px;
                line-height: 1.3;
            }

            #aircraft-detail .detail-item {
                display: flex;
                flex-direction: column;
                gap: 2px;
            }

            #aircraft-detail .detail-label {
                font-size: 9px;
                color: var(--text-secondary);
                opacity: 0.8;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            #aircraft-detail .detail-value {
                font-size: 10px;
                color: var(--text-primary);
                font-weight: 500;
                word-break: break-word;
            }

            #aircraft-detail .section-header {
                font-size: 9px;
                padding: 4px 0 2px 0;
                margin: 6px 0 3px 0;
                color: var(--text-accent);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            #aircraft-detail .close-btn {
                font-size: 24px;
                padding: 4px 10px;
                background: transparent;
                color: var(--text-primary);
                min-width: 44px;
                min-height: 44px;
            }

            #aircraft-detail .detail-footer {
                padding: 8px 12px;
                flex-shrink: 0;
            }

            #aircraft-detail .detail-footer .full-width-btn {
                padding: 12px 16px;
                font-size: 13px;
                min-height: 44px; /* Touch target */
            }

            /* Hide photo on mobile to save space */
            #aircraft-photo-container {
                display: none !important;
            }

            /* Adjust altitude chart for mobile - compact and always visible */
            #altitude-chart {
                bottom: 32px;  /* Higher above footer */
                left: 50%;
                transform: translateX(-50%);
                min-width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
                padding: 6px 8px;  /* Even more compact on mobile */
                font-size: 9px;
            }

            #altitude-chart .chart-title {
                font-size: 10px;
                margin-bottom: 3px;
            }

            #altitude-chart .gradient-bar {
                height: 14px;  /* Shorter on mobile */
            }

            /* Historical controls on mobile - positioning handled by utility classes */
            #historical-controls {
                /* Positioning handled by .mobile-panel-aligned utility class */
            }

            /* Mode selector on mobile - move to top right, smaller */
            #mode-selector {
                top: 10px;
                right: 10px;
                left: auto;
                flex-direction: row;
                gap: 4px;
                z-index: 110;  /* Above other panels */
            }

            /* North arrow on mobile - smaller */
            #north-arrow {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }

            #north-arrow .arrow-icon {
                font-size: 18px;
            }

            #north-arrow .arrow-label {
                font-size: 9px;
            }

            /* Compass heading indicator on mobile - smaller and repositioned */
            #compass-heading {
                top: 55px !important;
                left: 10px !important;
                padding: 3px 6px !important;
                gap: 4px !important;
            }

            #compass-heading-value {
                font-size: 10px !important;
            }

            #compass-cardinal {
                font-size: 9px !important;
            }

            /* Make modals mobile-friendly */
            #about-content,
            #keyboard-help-modal .modal-content {
                max-width: calc(100vw - 40px);
                max-height: calc(100vh - 80px);  /* More space on mobile for footer */
                padding: 20px;
                margin: 0 20px;
            }

            #about-content h2 {
                font-size: 22px;
            }

            #about-content p,
            #keyboard-help-modal p {
                font-size: 13px;
            }

            /* Unfollow button on mobile */
            #unfollow-btn {
                bottom: 110px;
                padding: 6px 16px;
                font-size: 12px;
            }

            /* Info panel stats tighter spacing */
            #info .stat {
                margin: 4px 0;
                font-size: 11px;
            }

            #info .stat .label {
                font-size: 10px;
            }

            #info .stat .value {
                font-size: 11px;
            }

            /* Consistent panel header styling on mobile */
            #controls .panel-header {
                margin-bottom: 3px;
                padding: 4px;
            }

            #controls .controls-title {
                font-size: 11px;
                margin-bottom: 0;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Toggle switch containers tighter on mobile */
            .toggle-switch-container {
                padding: 6px;
            }

            .toggle-switch-label {
                font-size: 10px;
            }

            .toggle-switch {
                width: 36px;
                height: 18px;
            }

            .toggle-switch::after {
                width: 14px;
                height: 14px;
            }

            /* Collapse button mobile sizing */
            .collapse-btn {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            /* About modal content spacing */
            #about-content h3 {
                font-size: 14px;
                margin: 15px 0 8px 0;
            }

            #about-content ul {
                margin: 8px 0;
                padding-left: 20px;
            }

            #about-content li {
                margin: 4px 0;
                font-size: 12px;
            }

            .feature-list {
                line-height: 1.4;
            }

            .version,
            .author {
                font-size: 11px;
                margin: 4px 0;
            }

            /* Keyboard help modal */
            #keyboard-help-modal .modal-content {
                padding: 15px;
            }

            #keyboard-help-modal h2 {
                font-size: 18px;
                margin-bottom: 10px;
            }

            #keyboard-help-modal h3 {
                font-size: 14px;
                margin: 12px 0 6px 0;
            }

            #keyboard-help-modal .shortcut-group {
                margin-bottom: 10px;
            }

            #keyboard-help-modal .shortcut-item {
                padding: 4px 0;
                font-size: 11px;
            }

            #keyboard-help-modal kbd {
                padding: 2px 6px;
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens - Pixel 7 Pro and similar */
            #info {
                top: 50px !important;  /* Below mode selector */
                left: auto !important;
                right: 10px !important;
                padding: 8px !important;
                max-width: calc(100vw - 30px);  /* Use available width minus margins */
                min-width: 220px;  /* Ensure minimum readable width */
            }

            #aircraft-list {
                /* Positioning handled by .mobile-panel-aligned utility class (480px) */
                max-width: calc(100vw - 30px) !important;
                min-width: 220px !important;
            }

            #controls {
                bottom: 100px;  /* Above footer */
                padding: 0;  /* No outer padding */
            }

            #controls.collapseable-panel .panel-content {
                max-height: 200px;  /* Even smaller for very small screens */
            }

            #controls button {
                padding: 5px 8px;
                font-size: 9px;
            }
        }

        /* Touch-friendly tap targets */
        @media (hover: none) and (pointer: coarse) {
            /* Ensure 44px minimum tap target sizes for touch devices (WCAG AA) */
            .collapse-btn {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }

            #controls button {
                padding: 12px 14px;
                margin: 2px 3px;
                min-height: 44px;
                font-size: 12px;
            }

            .close-btn {
                width: 44px;
                height: 44px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <!-- Unified Sidebar (replaces aircraft-list and historical-controls panels) -->
    <div id="unified-sidebar" class="sidebar">
        <!-- Resize Handle -->
        <div class="sidebar-resize-handle"></div>

        <!-- Collapse/Expand Button -->
        <button class="sidebar-toggle-btn" id="sidebar-toggle" title="Toggle sidebar">
            <span class="toggle-icon">â€º</span>
        </button>

        <!-- Lock/Pin Button -->
        <button class="sidebar-lock-btn" id="sidebar-lock" title="Lock sidebar open">
            <span class="lock-icon mdi mdi-lock-open-variant"></span>
        </button>

        <!-- Sidebar Content -->
        <div class="sidebar-content">
            <!-- Mode Header (clickable to toggle) -->
            <!-- Mode Tabs -->
            <div class="sidebar-mode-tabs">
                <button class="sidebar-mode-tab active" id="sidebar-tab-live" data-mode="live" title="Real-time aircraft tracking">
                    ðŸ”´ Live
                </button>
                <button class="sidebar-mode-tab" id="sidebar-tab-historical" data-mode="historical" title="Historical track playback">
                    ðŸ“Š Historical
                </button>
            </div>

            <!-- Live Mode Content -->
            <div id="sidebar-live-content" class="sidebar-mode-content">
                <!-- Stats Summary -->
                <div class="sidebar-stats">
                    <div class="stat-item">
                        <span class="stat-label">Aircraft:</span>
                        <span class="stat-value" id="sidebar-aircraft-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">With position:</span>
                        <span class="stat-value" id="sidebar-aircraft-positioned">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Updated:</span>
                        <span class="stat-value" id="sidebar-last-update">--</span>
                    </div>
                    <div class="stat-item" id="api-status-stat" style="display: none;">
                        <span class="stat-label">Track API:</span>
                        <span class="stat-value" id="api-status-inline">
                            <span class="api-status-dot-small" id="api-status-dot-inline"></span>
                            <span id="api-status-text-inline">--</span>
                        </span>
                    </div>
                </div>

                <div class="sidebar-divider"></div>

                <!-- Aircraft Search -->
                <div class="sidebar-search">
                    <input
                        type="text"
                        id="sidebar-aircraft-search"
                        placeholder="ðŸ” Search aircraft..."
                        autocomplete="off"
                        spellcheck="false"
                    />
                    <button id="sidebar-search-clear" class="search-clear-btn" title="Clear">âœ•</button>
                </div>

                <!-- Badge Legend -->
                <div class="sidebar-badge-legend">
                    <span class="legend-item">â¬†ï¸ Highest</span>
                    <span class="legend-item">âš¡ Fastest</span>
                    <span class="legend-item">ðŸ“ Closest</span>
                </div>

                <!-- Aircraft List -->
                <div class="sidebar-section-label">Nearby Aircraft</div>
                <div id="sidebar-aircraft-list" class="sidebar-aircraft-list">
                    <!-- Aircraft items will be populated here -->
                </div>
            </div>

            <!-- Historical Mode Content -->
            <div id="sidebar-historical-content" class="sidebar-mode-content" style="display: none;">
                <!-- Time Range & Load -->
                <div class="sidebar-section">
                    <div class="sidebar-section-label">Time Range</div>

                    <!-- Mode toggle: Quick presets vs Custom range -->
                    <div class="sidebar-button-group" style="margin-bottom: 10px;">
                        <button id="time-mode-preset" class="sidebar-button sidebar-button-active" style="font-size: 11px;">âš¡ Quick</button>
                        <button id="time-mode-custom" class="sidebar-button" style="font-size: 11px;">ðŸ“… Custom</button>
                    </div>

                    <!-- Quick presets (default) -->
                    <div id="time-preset-section">
                        <select id="sidebar-time-preset" class="sidebar-select">
                            <option value="1">Last 1 hour</option>
                            <option value="4">Last 4 hours</option>
                            <option value="8">Last 8 hours</option>
                            <option value="12">Last 12 hours</option>
                            <option value="24">Last 24 hours</option>
                        </select>
                    </div>

                    <!-- Custom date/time picker (hidden by default) -->
                    <div id="time-custom-section" style="display: none;">
                        <div style="margin-bottom: 8px;">
                            <label style="font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Start Date/Time:</label>
                            <input type="text" id="custom-start-time" class="sidebar-select calendar-input" value="ðŸ“… Click to select..." readonly>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: var(--text-secondary); display: block; margin-bottom: 4px;">End Date/Time:</label>
                            <input type="text" id="custom-end-time" class="sidebar-select calendar-input" value="ðŸ“… Click to select..." readonly>
                        </div>
                        <div style="margin-top: 6px; font-size: 10px; color: var(--text-secondary);">
                            <span id="custom-duration-display">Duration: --</span>
                        </div>
                        <div style="margin-top: 4px; font-size: 9px; color: var(--text-secondary); opacity: 0.7;">
                            Times are in your local timezone (<span id="timezone-indicator"></span>)
                        </div>
                    </div>

                    <button id="sidebar-load-tracks" class="sidebar-button sidebar-button-primary" style="margin-top: 10px;">Load Tracks</button>
                    <div id="sidebar-results-info" class="sidebar-info" style="margin-top: 8px;">Ready to load</div>
                </div>

                <div class="sidebar-divider"></div>

                <!-- Display Mode Selector -->
                <div id="sidebar-display-mode" class="sidebar-section" style="display: none;">
                    <div class="sidebar-section-label">Display Mode</div>
                    <div class="sidebar-button-group">
                        <button id="sidebar-mode-all" class="sidebar-button sidebar-button-active" title="Show all tracks at once">
                            ðŸ“Š All Tracks
                        </button>
                        <button id="sidebar-mode-playback" class="sidebar-button" title="Animate tracks over time">
                            â–¶ï¸ Playback
                        </button>
                    </div>
                </div>

                <!-- Visualization Mode (Track Lines/Heat Map/Both) -->
                <div id="sidebar-visualization-mode" class="sidebar-section" style="display: none;">
                    <div class="sidebar-section-label">Visualization</div>
                    <div class="sidebar-radio-group" style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="sidebar-radio-label">
                            <input type="radio" name="viz-mode" value="tracks" checked>
                            <span>Track Lines</span>
                        </label>
                        <label class="sidebar-radio-label">
                            <input type="radio" name="viz-mode" value="heatmap">
                            <span>Heat Map</span>
                        </label>
                        <label class="sidebar-radio-label">
                            <input type="radio" name="viz-mode" value="both">
                            <span>Both</span>
                        </label>
                    </div>
                </div>

                <!-- Playback Controls -->
                <div id="sidebar-playback-controls" class="sidebar-section" style="display: none;">
                    <div class="sidebar-section-label">Playback Controls</div>

                    <!-- Main playback buttons -->
                    <div class="sidebar-button-group">
                        <button id="sidebar-play-pause" class="sidebar-button sidebar-button-primary">
                            â–¶ï¸ Play
                        </button>
                        <button id="sidebar-restart" class="sidebar-button">
                            â® Restart
                        </button>
                    </div>

                    <!-- Speed control -->
                    <div class="sidebar-playback-speed" style="margin-top: 10px;">
                        <label style="font-size: 11px; color: var(--text-secondary);">Speed:</label>
                        <select id="sidebar-playback-speed" class="sidebar-select" style="width: 100px;">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10" selected>10x</option>
                            <option value="30">30x</option>
                            <option value="60">60x</option>
                        </select>
                    </div>

                    <!-- Skip controls -->
                    <div class="sidebar-skip-controls" style="margin-top: 10px;">
                        <label style="font-size: 11px; color: var(--text-secondary);">Skip:</label>
                        <div class="sidebar-button-group" style="grid-template-columns: repeat(4, 1fr);">
                            <button id="sidebar-skip-back-10" class="sidebar-button sidebar-button-small">-10m</button>
                            <button id="sidebar-skip-back-1" class="sidebar-button sidebar-button-small">-1m</button>
                            <button id="sidebar-skip-forward-1" class="sidebar-button sidebar-button-small">+1m</button>
                            <button id="sidebar-skip-forward-10" class="sidebar-button sidebar-button-small">+10m</button>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="sidebar-timeline" style="margin-top: 10px;">
                        <input type="range" id="sidebar-timeline" class="sidebar-range" min="0" max="100" value="0" style="width: 100%;">
                        <div class="sidebar-timeline-info" style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
                            <span id="sidebar-time-current">00:00</span>
                            <span id="sidebar-time-total">00:00</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-divider"></div>

                <!-- Track List -->
                <div id="sidebar-tracks-section" class="sidebar-section" style="display: none;">
                    <div class="sidebar-section-label">
                        <span>Loaded Tracks</span>
                        <span id="sidebar-track-count" style="font-weight: normal; color: var(--text-secondary);">(0)</span>
                    </div>

                    <!-- Track filters -->
                    <div class="sidebar-track-filters" style="margin-bottom: 10px;">
                        <input type="text" id="sidebar-track-search" placeholder="ðŸ” Search tracks..." class="sidebar-search-input" style="width: 100%;">
                    </div>

                    <!-- Track list -->
                    <div id="sidebar-track-list" class="sidebar-aircraft-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Track items will be populated here -->
                    </div>
                </div>

                <div class="sidebar-divider"></div>

                <!-- Post-Load Filters (shown after data is loaded) -->
                <div id="historical-filters" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(74, 158, 255, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="document.getElementById('filter-tracks-content').style.display = document.getElementById('filter-tracks-content').style.display === 'none' ? 'block' : 'none'; this.querySelector('.nested-collapse-btn').textContent = this.querySelector('.nested-collapse-btn').textContent === 'âˆ’' ? '+' : 'âˆ’';">
                        <label style="font-weight: bold; color: var(--text-accent); cursor: pointer;">Filter Tracks:</label>
                        <span class="nested-collapse-btn" style="color: var(--text-accent); font-size: 18px; user-select: none;">+</span>
                    </div>
                    <div id="filter-tracks-content" style="display: none;">

                    <!-- Military Only -->
                    <div class="historical-input-group">
                        <label for="filter-military-only">
                            <input type="checkbox" id="filter-military-only" style="width: auto; margin-right: 5px;">
                            Military Only
                        </label>
                    </div>

                    <!-- Altitude Range -->
                    <div class="historical-input-group">
                        <label for="filter-altitude-min">Min Altitude (ft):</label>
                        <input type="number" id="filter-altitude-min" class="historical-input" min="0" max="50000" step="1000" placeholder="0">
                    </div>
                    <div class="historical-input-group">
                        <label for="filter-altitude-max">Max Altitude (ft):</label>
                        <input type="number" id="filter-altitude-max" class="historical-input" min="0" max="50000" step="1000" placeholder="50000">
                    </div>

                    <!-- Minimum Track Length -->
                    <div class="historical-input-group">
                        <label for="filter-min-positions">Min Positions:</label>
                        <input type="number" id="filter-min-positions" class="historical-input" min="2" max="1000" value="10" title="Hide tracks with fewer than this many positions">
                    </div>

                    <!-- Speed Range -->
                    <div class="historical-input-group">
                        <label for="filter-speed-min">Min Speed (kts):</label>
                        <input type="number" id="filter-speed-min" class="historical-input" min="0" max="1000" step="50" placeholder="0">
                    </div>
                    <div class="historical-input-group">
                        <label for="filter-speed-max">Max Speed (kts):</label>
                        <input type="number" id="filter-speed-max" class="historical-input" min="0" max="1000" step="50" placeholder="1000">
                    </div>

                    <button id="apply-filters" class="historical-load-btn" style="margin-top: 10px;">Apply Filters</button>
                    </div>
                </div>
            </div>

            <!-- Sidebar Footer (Mini Radar + Heading) - REMOVED: Not needed, whole map is the radar -->
            <div class="sidebar-footer" id="sidebar-footer" style="display: none;">
                <button class="sidebar-footer-toggle" id="sidebar-footer-toggle" title="Toggle radar/heading">
                    <span>â¬†</span>
                </button>
                <div class="sidebar-footer-content" id="sidebar-footer-content">
                    <!-- Mini radar and heading container -->
                    <div id="sidebar-mini-radar-container" style="display: flex; align-items: center; justify-content: center; gap: 15px; padding: 10px;">
                        <!-- Mini Radar -->
                        <div style="position: relative;">
                            <canvas id="sidebar-mini-radar" width="120" height="120" style="border: 1px solid var(--panel-border); border-radius: 50%; background: rgba(0, 0, 0, 0.5);"></canvas>
                        </div>
                        <!-- Heading Display -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                            <div style="font-size: 9px; color: var(--text-secondary); text-transform: uppercase; opacity: 0.7;">Heading</div>
                            <div id="sidebar-heading-value" style="font-size: 18px; font-weight: bold; color: var(--text-primary); font-family: 'Courier New', monospace;">000Â°</div>
                            <div id="sidebar-cardinal-direction" style="font-size: 10px; color: var(--accent-primary); font-weight: 600;">N</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal">
        <div id="about-content">
            <button class="close-btn" id="close-about">Ã—</button>
            <h2>ADS-B 3D - Unified Viewer</h2>
            <p class="version">Version 2.0.0</p>
            <p class="author">Created by <strong>hook-365</strong></p>

            <p>
                Real-time and historical 3D visualization of ADS-B aircraft data.
                View live aircraft, replay historical tracks, and explore flight patterns
                in an immersive 3D environment with accurate airport and runway overlays.
            </p>

            <h3>Live Mode</h3>
            <ul class="feature-list">
                <li>Real-time 3D aircraft visualization</li>
                <li>Altitude-based color gradient (redâ†’orangeâ†’greenâ†’magenta)</li>
                <li>Flight path trails with recent history (1-30 min)</li>
                <li>Advanced aircraft type filtering</li>
                <li>Interactive aircraft selection & follow mode</li>
                <li>Live statistics dashboard</li>
            </ul>

            <h3>Historical Mode</h3>
            <ul class="feature-list">
                <li>Time travel: replay past 6+ days of flights</li>
                <li>Quick presets: 1, 4, 8, 12, 24 hours or custom range</li>
                <li>Post-load filters: aircraft type, altitude, track length, speed</li>
                <li>MLAT altitude smoothing (fixes zero-altitude glitches)</li>
                <li>Optimized rendering (instanced endpoints)</li>
                <li>Same altitude colors as live mode</li>
            </ul>

            <h3>Common Features</h3>
            <ul class="feature-list">
                <li>Airport & runway overlays (2000+ airports)</li>
                <li>Keyboard shortcuts (R, T, L, A, H)</li>
                <li>Distance rings & home location marker</li>
                <li>Smooth mode switching with fade transitions</li>
                <li>Responsive design (desktop & mobile)</li>
            </ul>

            <h3>Data Sources</h3>
            <p class="data-source">
                <strong>Live ADS-B Data:</strong><br>
                <a href="https://github.com/sdr-enthusiasts/docker-adsb-ultrafeeder" target="_blank" rel="noopener noreferrer">Ultrafeeder</a> -
                ADS-B receiver with MLAT support
            </p>
            <p class="data-source">
                <strong>Historical Data:</strong><br>
                Custom Track API with TimescaleDB - 6+ days of position history
            </p>
            <p class="data-source">
                <strong>Aircraft Type Database:</strong><br>
                <a href="https://github.com/Mictronics/readsb-protobuf" target="_blank" rel="noopener noreferrer">tar1090-db</a> (Mictronics) -
                Comprehensive aircraft type identification
            </p>
            <p class="data-source">
                <strong>Airport & Runway Data:</strong><br>
                <a href="https://ourairports.com/data/" target="_blank" rel="noopener noreferrer">OurAirports</a> -
                Open data for 2000+ airports and runways worldwide
            </p>
            <p class="data-source">
                <strong>Flight Routes:</strong><br>
                <a href="https://www.adsbdb.com/" target="_blank" rel="noopener noreferrer">adsbdb.com</a> -
                Free public API for flight routes and airline data<br>
                <span class="note">Note: Route data shows typical scheduled routes for flight numbers, not real-time flight plans.</span>
            </p>
            <p class="data-source">
                <strong>Aircraft Photos:</strong><br>
                <a href="https://airport-data.com/" target="_blank" rel="noopener noreferrer">Airport-Data.com</a> -
                Aircraft photography database
            </p>
            <p class="data-source">
                <strong>Map Tiles:</strong><br>
                <a href="https://carto.com/basemaps/" target="_blank" rel="noopener noreferrer">CartoDB Dark Matter</a> -
                Dark-themed basemap by CARTO
            </p>
            <p class="data-source">
                <strong>3D Graphics:</strong><br>
                â€¢ <a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">Three.js</a> - WebGL 3D rendering library
            </p>
            <p class="note" style="margin-top: 8px;">
                Note: Ground plane uses flat 2D map tiles - no 3D elevation data.
            </p>

            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center;">
                <a href="https://github.com/hook-365/adsb-3d" class="github-link" id="github-link" target="_blank" rel="noopener noreferrer">
                    ðŸ“¦ GitHub Repository
                </a>
                <a href="https://buymeacoffee.com/anthonyhook" class="github-link" target="_blank" rel="noopener noreferrer">
                    â˜• Buy me a coffee
                </a>
            </div>
        </div>
    </div>


    <!-- Unfollow Button (shown when following an aircraft) -->
    <button id="unfollow-btn">âœ• Unfollow</button>

    <div id="altitude-chart">
        <div class="chart-title">Altitude (ft)</div>
        <div class="gradient-bar"></div>
        <div class="labels">
            <span>0</span>
            <span>2k</span>
            <span>5k</span>
            <span>10k</span>
            <span>20k</span>
            <span>30k</span>
            <span>40k+</span>
        </div>
    </div>

    <div id="controls" class="collapseable-panel collapsed">
        <div class="panel-header">
            <span class="controls-title">âš™ï¸ Settings</span>
            <button class="collapse-btn" data-panel="controls" title="Collapse panel">+</button>
        </div>
        <div class="panel-content">
            <!-- Reset Camera Button (action button, not toggle) -->
            <button id="reset-camera" class="action-btn">â†» Reset Camera</button>

            <!-- Themes Button -->
            <button id="show-themes" class="action-btn">ðŸŽ¨ Themes</button>

            <!-- Toggle Switches (Reordered for better UX) -->
            <div class="toggle-switch-container active" id="toggle-sprite-mode-container">
                <span class="toggle-switch-label">Sprite Mode</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container" id="toggle-home-tower-container">
                <span class="toggle-switch-label">Home Tower</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-trails-container">
                <span class="toggle-switch-label">Trails</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container" id="toggle-trail-fade-container">
                <span class="toggle-switch-label">Trail Cleanup</span>
                <div class="toggle-switch"></div>
            </div>

            <!-- Trail Cleanup Time Selector (shown when trail cleanup is enabled) -->
            <div id="trail-fade-time-selector" style="display: none; margin-top: 8px; margin-bottom: 12px;">
                <label for="trail-fade-time" style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Remove trails after:</label>
                <select id="trail-fade-time" style="width: 100%; padding: 6px; background: var(--panel-bg); color: var(--text-primary); border: 1px solid var(--panel-border); border-radius: var(--input-radius); font-size: 12px;">
                    <option value="-1" selected>Immediate (when aircraft leaves)</option>
                    <option value="0">Never (accumulate all)</option>
                    <option value="60">1 minute</option>
                    <option value="300">5 minutes</option>
                    <option value="900">15 minutes</option>
                    <option value="1800">30 minutes</option>
                    <option value="3600">60 minutes</option>
                </select>
            </div>

            <!-- Preload Trail Time Selector -->
            <div style="margin-top: 12px; margin-bottom: 12px;">
                <label for="preload-trail-time" style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Preload trail history:</label>
                <select id="preload-trail-time" style="width: 100%; padding: 6px; background: var(--panel-bg); color: var(--text-primary); border: 1px solid var(--panel-border); border-radius: var(--input-radius); font-size: 12px;">
                    <option value="0">Off (none)</option>
                    <option value="1">1 minute</option>
                    <option value="5" selected>5 minutes (Default)</option>
                    <option value="15">15 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">60 minutes</option>
                </select>
            </div>

            <!-- Altitude Scale Selector -->
            <div style="margin-top: 12px; margin-bottom: 12px;">
                <label for="altitude-scale" style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Altitude Scale:</label>
                <select id="altitude-scale" style="width: 100%; padding: 6px; background: var(--panel-bg); color: var(--text-primary); border: 1px solid var(--panel-border); border-radius: var(--input-radius); font-size: 12px;">
                    <option value="1">1x (Real scale)</option>
                    <option value="2">2x</option>
                    <option value="3">3x</option>
                    <option value="4">4x</option>
                    <option value="4.5" selected>4.5x (Default)</option>
                    <option value="5">5x</option>
                    <option value="6">6x</option>
                    <option value="8">8x</option>
                    <option value="10">10x</option>
                </select>
            </div>

            <!-- Trail Color Mode Selector -->
            <div style="margin-top: 12px; margin-bottom: 12px;">
                <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Trail Colors:</label>
                <div style="display: flex; gap: 12px;">
                    <label style="font-size: 12px; color: var(--text-primary); cursor: pointer;">
                        <input type="radio" name="trail-color-mode" value="altitude" checked style="margin-right: 4px;">Altitude
                    </label>
                    <label style="font-size: 12px; color: var(--text-primary); cursor: pointer;">
                        <input type="radio" name="trail-color-mode" value="speed" style="margin-right: 4px;">Speed
                    </label>
                </div>
            </div>

            <div class="toggle-switch-container active" id="toggle-altitude-lines-container">
                <span class="toggle-switch-label">Alt Lines</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-tron-mode-container">
                <span class="toggle-switch-label">Tron Mode</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-labels-container">
                <span class="toggle-switch-label">Labels</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-airports-container">
                <span class="toggle-switch-label">Airports</span>
                <div class="toggle-switch"></div>
            </div>

            <div class="toggle-switch-container active" id="toggle-runways-container">
                <span class="toggle-switch-label">Runways</span>
                <div class="toggle-switch"></div>
            </div>

            <!-- Keyboard Help Button -->
            <button id="show-keyboard-help" class="secondary-btn">âŒ¨ï¸ Keyboard Shortcuts</button>
        </div>
    </div>

    <div id="aircraft-detail">
        <div class="detail-header">
            <h3 id="detail-callsign">Aircraft Details</h3>
            <button class="close-btn" id="close-detail">Ã—</button>
        </div>
        <div class="detail-body">
            <div class="detail-grid" id="detail-content"></div>
        </div>
        <div class="detail-footer">
            <button id="detail-follow-btn" class="full-width-btn">
                ðŸ“ Follow Aircraft
            </button>
        </div>
    </div>

    <div class="loading" id="loading">Loading...</div>

    <!-- Floating North Arrow on 3D Canvas -->
    <div id="north-arrow">
        <div class="arrow-icon">â†‘</div>
        <div class="arrow-label">N</div>
    </div>

    <!-- Compact Heading Indicator below Compass -->
    <div id="compass-heading" style="position: absolute; top: 75px; left: 20px; background: rgba(0, 0, 0, 0.7); border-radius: 6px; backdrop-filter: blur(10px); border: 1px solid var(--accent-primary-dim); padding: 4px 8px; z-index: 100; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); display: flex; align-items: center; gap: 6px;">
        <span id="compass-heading-value" style="font-size: 11px; font-weight: bold; color: var(--text-primary); font-family: 'Courier New', monospace;">000Â°</span>
        <span id="compass-cardinal" style="font-size: 10px; color: var(--accent-primary); font-weight: 600;">N</span>
    </div>

    <!-- Mini Statistics Panel -->

    <!-- Keyboard Hint (shows briefly on keypress) -->
    <div class="keyboard-hint" id="keyboard-hint"></div>

    <!-- Keyboard Help Modal -->
    <!-- Keyboard Help Sidebar (NEW) -->
    <div id="keyboard-help-overlay"></div>
    <div id="keyboard-help-sidebar">
        <div class="header">
            <h2>âŒ¨ï¸ Keyboard Shortcuts</h2>
            <button class="close-btn-help" id="close-keyboard-help-sidebar">Ã—</button>
        </div>
        <div class="content">
            <!-- Camera Controls -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">ðŸ“· Camera</div>
                <div class="shortcut-item">
                    <kbd>R</kbd>
                    <div>
                        <div class="shortcut-desc">Reset Camera</div>
                        <div class="mode-indicator">Returns to home location</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>Scroll</kbd>
                    <div>
                        <div class="shortcut-desc">Zoom In/Out</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>Drag</kbd>
                    <div>
                        <div class="shortcut-desc">Rotate View</div>
                        <div class="mode-indicator">Click and drag with mouse</div>
                    </div>
                </div>
            </div>

            <!-- Toggle Displays -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">ðŸŽšï¸ Display Toggles</div>
                <div class="shortcut-item">
                    <kbd>T</kbd>
                    <div>
                        <div class="shortcut-desc">Trails</div>
                        <div class="mode-indicator">Flight path lines</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>L</kbd>
                    <div>
                        <div class="shortcut-desc">Labels</div>
                        <div class="mode-indicator">Aircraft callsigns</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>A</kbd>
                    <div>
                        <div class="shortcut-desc">Airports</div>
                        <div class="mode-indicator">Markers & details</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>H</kbd>
                    <div>
                        <div class="shortcut-desc">Runways</div>
                        <div class="mode-indicator">Airport runway overlays</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>V</kbd>
                    <div>
                        <div class="shortcut-desc">Altitude Lines</div>
                        <div class="mode-indicator">Reference altitude rings</div>
                    </div>
                </div>
            </div>

            <!-- Visual Effects -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">âœ¨ Effects</div>
                <div class="shortcut-item">
                    <kbd>T</kbd>
                    <div>
                        <div class="shortcut-desc">Tron Mode</div>
                        <div class="mode-indicator">Altitude curtains (also in Settings)</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>C</kbd>
                    <div>
                        <div class="shortcut-desc">Compass</div>
                        <div class="mode-indicator">Direction indicator</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>M</kbd>
                    <div>
                        <div class="shortcut-desc">Mini Radar</div>
                        <div class="mode-indicator">Circle radar view</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">ðŸ§­ Navigation</div>
                <div class="shortcut-item">
                    <kbd>ESC</kbd>
                    <div>
                        <div class="shortcut-desc">Exit / Deselect</div>
                        <div class="mode-indicator">Close panels, stop following</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd>?</kbd>
                    <div>
                        <div class="shortcut-desc">Help</div>
                        <div class="mode-indicator">Show this panel</div>
                    </div>
                </div>
            </div>

            <!-- Mobile Gestures -->
            <div class="shortcut-group">
                <div class="shortcut-group-title">ðŸ“± Mobile Gestures</div>
                <div class="shortcut-item">
                    <kbd style="max-width: 100%;">Drag</kbd>
                    <div>
                        <div class="shortcut-desc">Rotate Camera</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd style="max-width: 100%; white-space: normal;">Pinch</kbd>
                    <div>
                        <div class="shortcut-desc">Zoom</div>
                    </div>
                </div>
                <div class="shortcut-item">
                    <kbd style="max-width: 100%; white-space: normal;">Long-press</kbd>
                    <div>
                        <div class="shortcut-desc">Aircraft Menu</div>
                        <div class="mode-indicator">Quick actions</div>
                    </div>
                </div>
            </div>

            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--panel-border);">
                ðŸ’¡ <strong>Tip:</strong> Click any aircraft to select it. Press <kbd style="padding: 2px 4px;">ESC</kbd> to deselect.
            </p>
        </div>
    </div>

    <!-- Legacy Keyboard Help Modal (kept for compatibility) -->
    <div id="keyboard-help-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-btn" id="close-keyboard-help">Ã—</button>
            <h2>Keyboard Shortcuts</h2>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; margin: 20px 0;">
                <kbd>R</kbd><span>Reset Camera</span>
                <kbd>T</kbd><span>Toggle Trails</span>
                <kbd>L</kbd><span>Toggle Labels</span>
                <kbd>A</kbd><span>Toggle Airports</span>
                <kbd>H</kbd><span>Toggle Runways</span>
                <kbd>V</kbd><span>Toggle Altitude Lines</span>
                <kbd>ESC</kbd><span>Close Modal / Exit Follow / Deselect</span>
                <kbd>?</kbd><span>Show This Help</span>
            </div>
            <p class="text-muted-sm" style="margin-top: 20px;">
                ðŸ’¡ <strong>Tip:</strong> Click any aircraft to select it, then press <kbd>ESC</kbd> to deselect.
            </p>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div id="theme-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-btn" id="close-theme-modal">Ã—</button>
            <h2>Choose Theme</h2>
            <p style="margin-bottom: 20px; color: var(--text-secondary); font-size: 13px;">
                Select a color scheme for the interface. Your preference is saved automatically.
            </p>

            <div class="theme-grid">
                <!-- Modern Theme -->
                <div class="theme-card" data-theme="modern">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #4a9eff;"></div>
                        <div class="preview-color" style="background: #ffffff;"></div>
                        <div class="preview-color" style="background: #aaaaaa;"></div>
                    </div>
                    <h3>Modern</h3>
                    <p>Clean blue interface</p>
                    <div class="theme-active-indicator">âœ“ Active</div>
                </div>

                <!-- Digital Theme -->
                <div class="theme-card" data-theme="digital">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #00ff00;"></div>
                        <div class="preview-color" style="background: #00aa00;"></div>
                        <div class="preview-color" style="background: #004400;"></div>
                    </div>
                    <h3>Digital/CRT</h3>
                    <p>Green terminal</p>
                    <div class="theme-active-indicator">âœ“ Active</div>
                </div>

                <!-- Dark Theme -->
                <div class="theme-card" data-theme="dark">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #ffffff;"></div>
                        <div class="preview-color" style="background: #888888;"></div>
                        <div class="preview-color" style="background: #000000;"></div>
                    </div>
                    <h3>Dark Mode</h3>
                    <p>Pure black OLED</p>
                    <div class="theme-active-indicator">âœ“ Active</div>
                </div>

                <!-- Arctic Theme -->
                <div class="theme-card" data-theme="arctic">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #00d4ff;"></div>
                        <div class="preview-color" style="background: #88c9e0;"></div>
                        <div class="preview-color" style="background: #1a3344;"></div>
                    </div>
                    <h3>Arctic</h3>
                    <p>Cool icy blues</p>
                    <div class="theme-active-indicator">âœ“ Active</div>
                </div>

                <!-- Sunset Theme -->
                <div class="theme-card" data-theme="sunset">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #ff6b35;"></div>
                        <div class="preview-color" style="background: #cc9988;"></div>
                        <div class="preview-color" style="background: #442233;"></div>
                    </div>
                    <h3>Sunset</h3>
                    <p>Warm orange/purple</p>
                    <div class="theme-active-indicator">âœ“ Active</div>
                </div>

                <!-- Neon Theme -->
                <div class="theme-card" data-theme="neon">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #ff1493;"></div>
                        <div class="preview-color" style="background: #cc66dd;"></div>
                        <div class="preview-color" style="background: #440066;"></div>
                    </div>
                    <h3>Neon</h3>
                    <p>Synthwave pink</p>
                    <div class="theme-active-indicator">âœ“ Active</div>
                </div>

                <!-- Vintage Theme -->
                <div class="theme-card" data-theme="vintage">
                    <div class="theme-preview">
                        <div class="preview-color" style="background: #ffb000;"></div>
                        <div class="preview-color" style="background: #cc8800;"></div>
                        <div class="preview-color" style="background: #4a3f35;"></div>
                    </div>
                    <h3>Vintage</h3>
                    <p>Amber radar</p>
                    <div class="theme-active-indicator">âœ“ Active</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Footer Bar with Integrated Altitude Chart (Mobile) -->
    <div id="footer-bar">
        <div id="footer-altitude">
            <div class="altitude-content">
                <span class="altitude-label">Alt:</span>
                <div class="gradient-bar"></div>
            </div>
            <div class="labels">
                <span>0</span>
                <span>2k</span>
                <span>5k</span>
                <span>10k</span>
                <span>20k</span>
                <span>30k</span>
                <span>40k+</span>
            </div>
        </div>
        <div id="footer-links">
            <a href="#" id="footer-about-link" class="footer-link">â„¹ï¸ About</a>
            <span class="footer-separator">â€¢</span>
            <a href="https://github.com/hook-365/adsb-3d" class="footer-link" target="_blank" rel="noopener noreferrer">ðŸ“¦ GitHub</a>
            <span class="footer-separator">â€¢</span>
            <a href="https://buymeacoffee.com/anthonyhook" class="footer-link coffee-link" target="_blank" rel="noopener noreferrer">â˜• Buy me a coffee</a>
        </div>
    </div>

    <!-- Custom Calendar Picker -->
    <div id="calendar-picker" class="calendar-picker" style="display: none;">
        <div class="calendar-header">
            <button class="calendar-nav" id="calendar-prev-month">â€¹</button>
            <span id="calendar-month-year">January 2025</span>
            <button class="calendar-nav" id="calendar-next-month">â€º</button>
        </div>
        <div class="calendar-weekdays">
            <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
        </div>
        <div id="calendar-days" class="calendar-days">
            <!-- Days will be generated by JS -->
        </div>
        <div class="calendar-time">
            <label>Time:</label>
            <input type="number" id="calendar-hour" min="0" max="23" value="12" class="calendar-time-input">
            <span>:</span>
            <input type="number" id="calendar-minute" min="0" max="59" value="0" class="calendar-time-input">
        </div>
        <div class="calendar-actions">
            <button id="calendar-cancel" class="calendar-btn">Cancel</button>
            <button id="calendar-ok" class="calendar-btn calendar-btn-primary">OK</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Dynamically load config.js, constants.js, and app.js with correct path
        // This handles both /3d and /3d/ correctly
        (function() {
            // Get the current path and ensure it ends with /
            let scriptPath = window.location.pathname;
            // If path ends with .html file, use the directory part
            if (scriptPath.endsWith('.html')) {
                scriptPath = scriptPath.substring(0, scriptPath.lastIndexOf('/') + 1);
            } else if (!scriptPath.endsWith('/')) {
                scriptPath = scriptPath + '/';
            }
            // Ensure we have at least root path
            if (!scriptPath || scriptPath === '') {
                scriptPath = '/';
            }

            function loadScript(src, isModule = false) {
                const script = document.createElement('script');
                // Add cache-busting timestamp to force fresh load
                script.src = scriptPath + src + '?v=' + Date.now();
                if (isModule) {
                    script.type = 'module';
                }
                document.body.appendChild(script);
                return script;
            }

            // Load config.js first (dynamically generated env vars)
            loadScript('config.js');

            // Load constants.js as a module (refactored constants)
            loadScript('constants.js', true);

            // Load theme-manager.js as a module (refactored theme system)
            loadScript('theme-manager.js', true);

            // Load url-state-manager.js as a module (refactored URL state management)
            loadScript('url-state-manager.js', true);

            // Load aircraft-database.js as a module (refactored aircraft database and specs)
            loadScript('aircraft-database.js', true);

            // Load data-service-live.js as a module (refactored live data fetching)
            loadScript('data-service-live.js', true);

            // Load data-service-historical.js as a module (refactored historical data loading)
            loadScript('data-service-historical.js', true);

            // Load historical-mode.js as a module (historical track rendering, playback, heat maps)
            loadScript('historical-mode.js', true);

            // Load aircraft-svg-system.js
            loadScript('aircraft-svg-system.js');

            // Load app.js as a module (imports from constants.js, theme-manager.js, and url-state-manager.js)
            loadScript('app.js', true);
        })();
    </script>
</body>
</html>
